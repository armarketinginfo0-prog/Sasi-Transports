<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sasi Kumar Transports ‚Äî Trip Manager</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
      --radius: 12px;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #e0f2fe, #f9fafb);
      color: var(--text-main);
      min-height: 100vh;
      padding: 16px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* NAV BAR */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding: 10px 16px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(15, 23, 42, 0.04);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      border: 1px solid rgba(15, 23, 42, 0.03);
    }

    .form-card {
      flex: 2;
    }

    .summary-card-wrapper {
      flex: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin: 4px 0 4px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 6px;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    input, select, textarea {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      background: #f9fafb;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    input[type="date"] {
      padding-inline: 10px;
    }

    input[readonly] {
      background: #e5e7eb;
      cursor: default;
    }

    .muted {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      padding: 9px 18px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .btn-large {
      padding: 14px 24px;
      font-size: 1rem;
      border-radius: 999px;
      justify-content: center;
      width: 100%;
    }

    .summary-card {
      min-width: 0;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .summary-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .summary-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .summary-item {
      border-radius: 10px;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 2px;
    }

    .summary-value.positive {
      color: var(--success);
    }

    .summary-value.negative {
      color: var(--danger);
    }

    .summary-footer {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #e5e7eb;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .summary-footer-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.72rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .badge-dot.profit {
      background: var(--success);
    }

    .badge-dot.loss {
      background: var(--danger);
    }

    .badge-dot.pending {
      background: #f59e0b;
    }

    .tip {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tip strong {
      color: var(--text-main);
    }

    .step {
      display: none;
    }
    .step.active {
      display: block;
    }

    .step-indicator {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    .summary-small {
      opacity: 0.9;
      transform: scale(0.98);
    }

    .summary-full {
      max-width: 900px;
      margin: 0 auto;
      transform: scale(1);
    }

    .summary-full .summary-title {
      font-size: 1.1rem;
    }

    .summary-full .summary-grid .summary-item {
      padding: 10px 12px;
    }

    /* Saved message */
    .saved-message {
      margin-top: 12px;
      text-align: center;
      font-size: 0.9rem;
    }

    .saved-message p {
      margin-bottom: 8px;
      color: var(--text-muted);
    }

    /* Trips table */
    .table-wrapper {
      margin-top: 10px;
      overflow-x: auto;
    }

    .trips-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .trips-table thead {
      background: #eff6ff;
    }

    .trips-table th,
    .trips-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    .trips-table th {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }

    .trips-table td {
      font-size: 0.95rem;
    }

    .trips-table tr:hover {
      background: #eef2ff;
      cursor: pointer;
    }

    /* Mode screen */
    .mode-card {
      margin-top: 8px;
      text-align: center;
    }

    .mode-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mode-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .mode-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 420px;
      margin: 0 auto;
      margin-top: 8px;
    }

    @media (min-width: 600px) {
      .mode-actions {
        flex-direction: row;
      }
    }

    /* History search */
    .history-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .history-search-input {
      min-width: 180px;
      max-width: 260px;
    }

    .history-search-input input {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.85rem;
    }

    /* Status dot */
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      display: inline-block;
    }

    .status-dot.active {
      background: #16a34a;
    }

    .status-dot.closed {
      background: #9ca3af;
    }

    .status-dot.loss {
      background: #b91c1c;
    }

    /* Active trips card */
    .active-card {
      margin-top: 16px;
      text-align: left;
    }

    .active-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .active-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 0.9rem;
    }

    .active-item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .active-item-text {
      display: flex;
      flex-direction: column;
    }

    .active-item-route {
      font-weight: 600;
    }

    .active-item-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Update page (transactions) */
    .update-layout {
      max-width: 900px;
      margin: 0 auto;
      margin-top: 8px;
    }

    .txns-grid {
      display: grid;
      gap: 12px;
    }
    @media(min-width:900px){ .txns-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

    .category-block {
      border: 1px solid #eef2ff;
      background: linear-gradient(180deg,#fff,#fbfdff);
      padding: 10px;
      border-radius: 10px;
    }

    .category-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .category-total{font-weight:700;color:var(--text-main)}
    .txn-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .txn-row{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid #eef6ff}
    .txn-meta{font-size:0.92rem;color:var(--text-muted)}
    .txn-actions button{border-radius:8px;padding:6px 8px;border:1px solid #e6e7eb;background:transparent;cursor:pointer}

    .small-inputs{display:flex;gap:8px;align-items:center}
    .small-inputs input[type="number"]{width:110px;border-radius:8px}
    .small-inputs input[type="date"]{width:150px;border-radius:8px}
    .small-inputs button{white-space:nowrap}

    .update-footer { margin-top:10px; display:flex; gap:8px; justify-content:flex-end; }

    /* Toast */
    #toast-container {
      position: fixed;
      right: 16px;
      bottom: 18px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: rgba(17,24,39,0.98);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.2);
      min-width: 220px;
      font-size: 0.95rem;
    }
    .toast.success { background: linear-gradient(90deg,#065f46,#10b981); }
    .toast.error { background: linear-gradient(90deg,#7f1d1d,#ef4444); }
    .toast.info { background: linear-gradient(90deg,#0f172a,#1e293b); }

    /* small file input style */
    .file-input {
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .file-input input[type=file] { display:none; }

  </style>
</head>
<body>
  <div class="page">
    <!-- NAV BAR -->
    <header>
      <div class="header-left">
        <h1>Sasi Kumar Transports</h1>
        <p>Trip manager ‚Äî create, track and close your transport trips.</p>
      </div>
      <div class="header-actions">
        <button class="btn-ghost" id="headerHomeBtn">üè† Home</button>
        <button class="btn-outline hidden" id="headerViewHistoryBtn">üìú View history</button>

        <!-- CSV export / import controls added -->
        <button class="btn-ghost btn-small" id="exportCsvBtn" title="Export trips as CSV">‚¨áÔ∏è Export CSV</button>
        <label class="file-input btn-ghost btn-small" title="Import trips from CSV">
          ‚¨ÜÔ∏è Import CSV
          <input type="file" id="importCsvInput" accept=".csv,text/csv" />
        </label>
      </div>
    </header>

    <!-- HOME: New Trip / View history + Active trip list -->
    <div class="card mode-card" id="modeScreen">
      <div class="mode-title">What do you want to do?</div>
      <div class="mode-subtitle">Choose an option below to get started.</div>
      <div class="mode-actions">
        <button class="btn-primary btn-large" id="modeNewTripBtn">
          ‚ûï New Trip
        </button>
        <button class="btn-outline btn-large" id="modeViewHistoryBtn">
          üìú View history
        </button>
      </div>

      <!-- Active trip list on home -->
      <div class="card active-card" id="activeTripsCard">
        <div class="card-header" style="margin-bottom:6px;">
          <h2>Active trip</h2>
        </div>
        <div class="active-list" id="activeTripsBody">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>

    <!-- MAIN LAYOUT (New Trip mode: form + summary) -->
    <div class="layout hidden" id="mainLayout">
      <!-- LEFT: BIG FORM -->
      <div class="card form-card" id="formCard">
        <div class="card-header">
          <h2>
            Trip Entry
            <span class="pill" id="stepPill">Step 1 of 2</span>
          </h2>
          <span class="step-indicator" id="stepIndicator">Route details</span>
        </div>

        <form id="tripForm">
          <!-- STEP 1 -->
          <div class="step active" id="step1">
            <div class="section-title">Route details</div>

            <div class="field-group">
              <div class="input-group">
                <label for="routeFrom">From (state / district)</label>
                <input list="locationList" id="routeFrom" placeholder="Type and select..." required />
              </div>
              <div class="input-group">
                <label for="routeTo">To (state / district)</label>
                <input list="locationList" id="routeTo" placeholder="Type and select..." required />
              </div>
              <div class="input-group">
                <label for="startDate">Start date</label>
                <input type="date" id="startDate" required />
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn-primary" id="nextStepBtn">
                Next
              </button>
              <button type="reset" class="btn-ghost" id="resetBtn">
                Clear
              </button>
            </div>
            <p class="tip">
              Step 1: Enter starting details. After this, a <strong>Trip Code</strong> will be generated automatically.
            </p>
          </div>

          <!-- STEP 2 -->
          <div class="step" id="step2">
            <div class="section-title">Trip code & cost details</div>

            <div class="field-group">
              <div class="input-group">
                <label for="tripCode">Trip code (auto-generated)</label>
                <input type="text" id="tripCode" readonly />
              </div>
            </div>

            <div class="field-group">
              <div class="input-group">
                <label for="totalCost">Total transport cost (amount you charge client) (‚Çπ)</label>
                <input type="number" id="totalCost" placeholder="e.g. 50000" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="estimatedCost">Estimated total trip cost (your expected trip expense) (‚Çπ)</label>
                <input type="number" id="estimatedCost" placeholder="e.g. 38000" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="advancePaid">Advance paid (‚Çπ)</label>
                <input type="number" id="advancePaid" placeholder="e.g. 15000" min="0" step="0.01" />
              </div>
              <div class="input-group" id="advanceDateGroup" style="display:none;">
                <label for="advancePaidDate">Advance paid date</label>
                <input type="date" id="advancePaidDate" />
              </div>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">
                Save &amp; Calculate
              </button>
              <button type="button" class="btn-ghost" id="backStepBtn">
                Back
              </button>
            </div>
            <p class="tip">
              Estimated profit = Total transport cost ‚àí Estimated total trip cost.  
              Pending from client = Total transport cost ‚àí Advance.
            </p>
          </div>
        </form>
      </div>

      <!-- RIGHT: SUMMARY -->
      <div class="summary-card-wrapper" id="summaryWrapper">
        <div class="card summary-card summary-small" id="summaryCard">
          <div class="summary-header">
            <div>
              <div class="summary-title">Trip Summary</div>
              <div class="muted" id="summaryTitle">Fill the form to see totals.</div>
            </div>
            <div class="summary-header-actions">
              <button class="btn-outline hidden" id="newTripBtn">New Trip</button>
              <span class="summary-pill" id="summaryStatus">Preview</span>
            </div>
          </div>

          <!-- Summary content (grid + footer) -->
          <div id="summaryContent">
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Trip code</div>
                <div class="summary-value" id="tripCodeDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Route</div>
                <div class="summary-value" id="routeDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Start date</div>
                <div class="summary-value" id="startDateDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Total transport cost (client billing)</div>
                <div class="summary-value" id="totalCostDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Estimated total trip cost</div>
                <div class="summary-value" id="estimatedCostDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Estimated profit (total ‚àí est)</div>
                <div class="summary-value" id="profitDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Advance paid</div>
                <div class="summary-value" id="advanceDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Pending from client (total ‚àí advance)</div>
                <div class="summary-value" id="pendingDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Advance paid date</div>
                <div class="summary-value" id="advanceDateDisplay">‚Äî</div>
              </div>
            </div>

            <div class="summary-footer">
              <div>
                <div class="badge" id="profitBadge">
                  <span class="badge-dot profit"></span>
                  <span id="profitBadgeText">No profit data yet</span>
                </div>
                <div class="badge">
                  <span class="badge-dot pending"></span>
                  <span id="pendingBadgeText">No pending amount yet</span>
                </div>
              </div>
              <div class="summary-footer-controls">
                <button class="btn-ghost" id="editTripBtn">Edit</button>
                <button class="btn-primary" id="summarySaveBtn">Save</button>
              </div>
            </div>
          </div>

          <!-- Saved message shown after Save -->
          <div class="saved-message hidden" id="savedMessage">
            <p>Record saved, thank you.</p>
            <button class="btn-primary" id="viewSavedRecordBtn">View saved record</button>
          </div>
        </div>
      </div>
    </div>

    <!-- UPDATE PAGE (Incremental) -->
    <div class="card hidden" id="updateCard">
      <div class="update-layout">
        <div class="card-header">
          <h2>Update Trip (Add new payments & expenses)</h2>
          <span class="pill" id="updateTripCodeTag">TRIP</span>
        </div>

        <div class="update-summary">
          <div><strong>Route:</strong> <span id="updateRouteDisplay">‚Äî</span></div>
          <div><strong>Start date:</strong> <span id="updateStartDateDisplay">‚Äî</span></div>
          <div><strong>Pending from client:</strong> <span id="updatePendingDisplay">‚Çπ0</span></div>
        </div>

        <!-- NEW TRANSACTIONS UI -->
        <div class="section-title">Add dated transactions (all optional)</div>
        <div class="txns-grid" id="txnsGrid">
          <!-- Category blocks will be injected by JS -->
        </div>

        <div class="update-footer">
          <button class="btn-ghost" id="updateBackBtn">Back</button>
          <button class="btn-primary" id="updateDoneBtn">Done</button>
        </div>
      </div>
    </div>

    <!-- SAVED TRIPS LIST (View history) -->
    <div class="card hidden" id="tripsListCard" style="margin-top:16px;">
      <div class="card-header">
        <h2>Saved Trips (this device)</h2>
        <div class="history-header-right">
          <div class="history-search-input">
            <input
              type="text"
              id="historySearch"
              placeholder="Search by trip code, from, to..."
            />
          </div>
          <button class="btn-outline" id="historyNewTripBtn">‚ûï New Trip</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="trips-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Trip Code</th>
              <th>Route</th>
              <th>Start Date</th>
              <th>Total Cost</th>
              <th>Est. Cost</th>
              <th>Amount Used</th>
              <th>Amount Left</th>
              <th>Est. Profit</th>
              <th>Pending</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tripsTableBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
      <p class="tip">Tap / click a row to load that trip into the form for editing.</p>
    </div>
  </div>

  <!-- LOCATIONS -->
  <datalist id="locationList">
    <!-- States / UTs -->
    <option value="Andhra Pradesh"></option>
    <option value="Arunachal Pradesh"></option>
    <option value="Assam"></option>
    <option value="Bihar"></option>
    <option value="Chhattisgarh"></option>
    <option value="Goa"></option>
    <option value="Gujarat"></option>
    <option value="Haryana"></option>
    <option value="Himachal Pradesh"></option>
    <option value="Jharkhand"></option>
    <option value="Karnataka"></option>
    <option value="Kerala"></option>
    <option value="Madhya Pradesh"></option>
    <option value="Maharashtra"></option>
    <option value="Manipur"></option>
    <option value="Meghalaya"></option>
    <option value="Mizoram"></option>
    <option value="Nagaland"></option>
    <option value="Odisha"></option>
    <option value="Punjab"></option>
    <option value="Rajasthan"></option>
    <option value="Sikkim"></option>
    <option value="Tamil Nadu"></option>
    <option value="Telangana"></option>
    <option value="Tripura"></option>
    <option value="Uttar Pradesh"></option>
    <option value="Uttarakhand"></option>
    <option value="West Bengal"></option>
    <option value="Andaman and Nicobar Islands"></option>
    <option value="Chandigarh"></option>
    <option value="Dadra and Nagar Haveli and Daman and Diu"></option>
    <option value="Delhi"></option>
    <option value="Jammu and Kashmir"></option>
    <option value="Ladakh"></option>
    <option value="Lakshadweep"></option>
    <option value="Puducherry"></option>

    <!-- Sample cities -->
    <option value="Tamil Nadu - Chennai"></option>
    <option value="Tamil Nadu - Coimbatore"></option>
    <option value="Tamil Nadu - Erode"></option>
    <option value="Tamil Nadu - Tiruppur"></option>
    <option value="Tamil Nadu - Madurai"></option>
    <option value="Tamil Nadu - Salem"></option>
    <option value="Tamil Nadu - Trichy"></option>
    <option value="Tamil Nadu - Hosur"></option>

    <option value="Karnataka - Bengaluru"></option>
    <option value="Karnataka - Mangalore"></option>
    <option value="Karnataka - Mysuru"></option>

    <option value="Maharashtra - Mumbai"></option>
    <option value="Maharashtra - Pune"></option>
    <option value="Gujarat - Ahmedabad"></option>
    <option value="Gujarat - Surat"></option>
    <option value="Delhi - New Delhi"></option>
    <option value="West Bengal - Kolkata"></option>
  </datalist>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ---------- Utilities ---------- */
    function toNumber(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function formatCurrency(v) {
      return "‚Çπ" + Number(v || 0).toLocaleString("en-IN", { maximumFractionDigits: 2 });
    }

    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }

    function uid(prefix = "") {
      return prefix + Date.now().toString(36) + "-" + Math.floor(Math.random()*10000).toString(36);
    }

    // ---------- API SETTINGS ----------
    // By default same origin. Set to your API base if different.
    const API_BASE = window.location.origin; // change if needed (e.g. "https://api.yoursite.com")

    // ---------- Toast UI (replaces alert) ----------
    const toastContainer = document.getElementById("toast-container");
    function showToast(msg, type = "info", timeout = 3500) {
      const d = document.createElement("div");
      d.className = "toast " + (type || "info");
      d.textContent = msg;
      toastContainer.appendChild(d);
      setTimeout(() => {
        d.style.transition = "opacity 0.25s";
        d.style.opacity = "0";
        setTimeout(() => d.remove(), 250);
      }, timeout);
    }

    // ---------- Storage helpers ----------
    function getStoredTrips() {
      const raw = localStorage.getItem("trips");
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveTrips(trips) {
      localStorage.setItem("trips", JSON.stringify(trips));
    }

    // ---------- Categories (display order & keys) ----------
    const CATEGORIES = [
      { key: "diesel", label: "Diesel charge" },
      { key: "loading", label: "Loading charge" },
      { key: "office", label: "Office commission" },
      { key: "fastag", label: "Fastag fee" },
      { key: "driver", label: "Driver charge" },
      { key: "unloading", label: "Unloading charge" },
      { key: "receiver", label: "Receiver balance" },
      { key: "misc", label: "Miscellaneous" }
    ];

    // ---------- Derived-calculation helpers ----------
    function ensureTripTransactions(trip) {
      if (!trip.transactions || typeof trip.transactions !== "object") trip.transactions = {};
      CATEGORIES.forEach(c => { if (!Array.isArray(trip.transactions[c.key])) trip.transactions[c.key] = []; });
      if (!Array.isArray(trip.payments)) trip.payments = [];
    }

    function sumCategory(trip, catKey) {
      ensureTripTransactions(trip);
      return trip.transactions[catKey].reduce((s, x) => s + (toNumber(x.amount) || 0), 0);
    }

    function calculateAmountUsed(trip) {
      ensureTripTransactions(trip);
      return CATEGORIES.reduce((s, c) => s + sumCategory(trip, c.key), 0);
    }

    function calculatePaymentsSum(trip) {
      ensureTripTransactions(trip);
      return (trip.payments || []).reduce((s, p) => s + (toNumber(p.amount) || 0), 0);
    }

    function calculateAmountLeft(trip) {
      const advance = toNumber(trip.advancePaid || 0);
      const paid = calculatePaymentsSum(trip);
      const used = calculateAmountUsed(trip);
      return (advance + paid) - used;
    }

    function updateDerivedCategoryTotals(trip) {
      ensureTripTransactions(trip);
      trip.dieselCost = sumCategory(trip, "diesel");
      trip.loadingCost = sumCategory(trip, "loading");
      trip.officeCommission = sumCategory(trip, "office");
      trip.fastagCost = sumCategory(trip, "fastag");
      trip.driverCost = sumCategory(trip, "driver");
      trip.unloadingCost = sumCategory(trip, "unloading");
      trip.receiverBalance = sumCategory(trip, "receiver");
      trip.miscCost = sumCategory(trip, "misc");
    }

    // ---------- Sync helper (create/update) ----------
    // IMPORTANT: network failures are SILENCED (no failure toasts)
    async function saveTrip(payload) {
      try {
        const trips = getStoredTrips();
        const idx = trips.findIndex(t => t.tripCode === payload.tripCode);
        if (idx >= 0) trips[idx] = payload;
        else trips.push(payload);
        saveTrips(trips);
      } catch (err) {
        console.error("local save failed", err);
      }

      // Attempt server sync but keep network failures silent (only success shows toast)
      if (!API_BASE) {
        payload.syncStatus = "local";
        const trips = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
        saveTrips(trips);
        return;
      }

      try {
        const tripsLocal = getStoredTrips();
        const exists = tripsLocal.some(t => t.tripCode === payload.tripCode);
        const method = exists ? "PUT" : "POST";
        const url = API_BASE + "/trips" + (method === "PUT" ? ("/" + encodeURIComponent(payload.tripCode)) : "");
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          // mark as failed but DO NOT show network failure toast
          payload.syncStatus = "failed";
          const updated = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
          saveTrips(updated);
          console.warn("Sync failed (status)", res.status);
          return;
        }

        const serverObj = await res.json().catch(() => null);
        payload.syncStatus = "ok";
        if (serverObj && typeof serverObj === "object") Object.assign(payload, serverObj);
        const final = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
        saveTrips(final);
        // success toast only
        showToast("Saved & synced to server.", "success");
      } catch (err) {
        // silent on network error ‚Äî keep local copy and mark failed
        console.warn("Silent sync error:", err);
        try {
          payload.syncStatus = "failed";
          const updated = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
          saveTrips(updated);
        } catch (e) {}
      }
    }

    // ---------- Trip code ---------- (unchanged)
    const usedTripCodes = new Set();
    function generateTripCode(startDate) {
      if (!startDate) startDate = new Date().toISOString().slice(0,10);
      const y = startDate.slice(0, 4);
      const m = startDate.slice(5, 7);
      const d = startDate.slice(8, 10);
      let code;
      do {
        const random = Math.floor(10000 + Math.random() * 90000);
        code = `TR-${y}${m}${d}-${random}`;
      } while (usedTripCodes.has(code));
      usedTripCodes.add(code);
      return code;
    }

    // ---------- DOM refs ----------
    let currentUpdateTripCode = null;
    const modeScreen = document.getElementById("modeScreen");
    const modeNewTripBtn = document.getElementById("modeNewTripBtn");
    const modeViewHistoryBtn = document.getElementById("modeViewHistoryBtn");
    const headerHomeBtn = document.getElementById("headerHomeBtn");
    const headerViewHistoryBtn = document.getElementById("headerViewHistoryBtn");

    const mainLayout = document.getElementById("mainLayout");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const nextStepBtn = document.getElementById("nextStepBtn");
    const backStepBtn = document.getElementById("backStepBtn");
    const resetBtn = document.getElementById("resetBtn");
    const stepPill = document.getElementById("stepPill");
    const stepIndicator = document.getElementById("stepIndicator");
    const advancePaidInput = document.getElementById("advancePaid");
    const advanceDateGroup = document.getElementById("advanceDateGroup");
    const tripCodeInput = document.getElementById("tripCode");
    const formCard = document.getElementById("formCard");
    const summaryCard = document.getElementById("summaryCard");
    const summaryContent = document.getElementById("summaryContent");
    const savedMessage = document.getElementById("savedMessage");
    const viewSavedRecordBtn = document.getElementById("viewSavedRecordBtn");
    const newTripBtn = document.getElementById("newTripBtn");
    const editTripBtn = document.getElementById("editTripBtn");
    const summarySaveBtn = document.getElementById("summarySaveBtn");
    const tripsListCard = document.getElementById("tripsListCard");
    const historyNewTripBtn = document.getElementById("historyNewTripBtn");
    const tripsTableBody = document.getElementById("tripsTableBody");
    const historySearch = document.getElementById("historySearch");
    const activeTripsBody = document.getElementById("activeTripsBody");

    const updateCard = document.getElementById("updateCard");
    const updateTripCodeTag = document.getElementById("updateTripCodeTag");
    const updateRouteDisplay = document.getElementById("updateRouteDisplay");
    const updateStartDateDisplay = document.getElementById("updateStartDateDisplay");
    const updatePendingDisplay = document.getElementById("updatePendingDisplay");
    const txnsGrid = document.getElementById("txnsGrid");
    const updateBackBtn = document.getElementById("updateBackBtn");
    const updateDoneBtn = document.getElementById("updateDoneBtn");

    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const importCsvInput = document.getElementById("importCsvInput");

    // ---------- Summary reset ----------
    function resetSummary() {
      document.getElementById("tripCodeDisplay").textContent = "‚Äî";
      document.getElementById("routeDisplay").textContent = "‚Äî";
      document.getElementById("startDateDisplay").textContent = "‚Äî";
      document.getElementById("totalCostDisplay").textContent = "‚Çπ0";
      document.getElementById("estimatedCostDisplay").textContent = "‚Çπ0";
      document.getElementById("profitDisplay").textContent = "‚Çπ0";
      document.getElementById("advanceDisplay").textContent = "‚Çπ0";
      document.getElementById("pendingDisplay").textContent = "‚Çπ0";
      document.getElementById("advanceDateDisplay").textContent = "‚Äî";
      document.getElementById("summaryStatus").textContent = "Preview";
      document.getElementById("summaryTitle").textContent = "Fill the form to see totals.";
      document.getElementById("profitBadgeText").textContent = "No profit data yet";
      document.getElementById("pendingBadgeText").textContent = "No pending amount yet";
      document.getElementById("profitDisplay").classList.remove("positive", "negative");

      formCard.classList.remove("hidden");
      summaryCard.classList.remove("summary-full");
      summaryCard.classList.add("summary-small");
      newTripBtn.classList.add("hidden");

      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
    }

    // ---------- Render active trips ----------
    function renderActiveTrips() {
      const trips = getStoredTrips().filter(
        t => (t.status || "active") !== "closed"
      );
      activeTripsBody.innerHTML = "";

      if (!trips.length) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "No active trips.";
        activeTripsBody.appendChild(p);
        return;
      }

      trips.forEach(trip => {
        if (trip.tripCode) usedTripCodes.add(trip.tripCode);

        const item = document.createElement("div");
        item.className = "active-item";

        const main = document.createElement("div");
        main.className = "active-item-main";

        const dot = document.createElement("span");
        const isLoss = (trip.estimatedProfit || 0) < 0;
        dot.className = "status-dot " + (isLoss ? "loss" : "active");

        const textWrap = document.createElement("div");
        textWrap.className = "active-item-text";

        const routeText = document.createElement("div");
        routeText.className = "active-item-route";
        routeText.textContent =
          (trip.tripCode ? trip.tripCode + " ‚Ä¢ " : "") +
          (trip.routeFrom || "") +
          " ‚Üí " +
          (trip.routeTo || "");

        const meta = document.createElement("div");
        meta.className = "active-item-meta";
        meta.textContent = trip.startDate
          ? "Start: " + trip.startDate
          : "No start date";

        textWrap.appendChild(routeText);
        textWrap.appendChild(meta);

        main.appendChild(dot);
        main.appendChild(textWrap);

        const btnWrap = document.createElement("div");
        btnWrap.style.display = "flex";
        btnWrap.style.gap = "6px";

        const updateBtn = document.createElement("button");
        updateBtn.className = "btn-ghost btn-small";
        updateBtn.textContent = "Update";
        updateBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          updateTrip(trip.tripCode);
        });

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn-ghost btn-small";
        closeBtn.textContent = "Close trip";
        closeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeTrip(trip.tripCode);
        });

        btnWrap.appendChild(updateBtn);
        btnWrap.appendChild(closeBtn);

        item.appendChild(main);
        item.appendChild(btnWrap);

        activeTripsBody.appendChild(item);
      });
    }

    // ---------- Render trips table (updated to include Amount Used & Amount Left) ----------
    function renderTripsTable() {
      const q = (historySearch.value || "").trim().toLowerCase();
      const trips = getStoredTrips();
      tripsTableBody.innerHTML = "";

      let filtered = trips;
      if (q) {
        filtered = trips.filter(t => {
          const code = (t.tripCode || "").toLowerCase();
          const from = (t.routeFrom || "").toLowerCase();
          const to = (t.routeTo || "").toLowerCase();
          return code.includes(q) || from.includes(q) || to.includes(q);
        });
      }

      if (!filtered.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        // updated colspan to match new column count (11)
        cell.colSpan = 11;
        cell.textContent = q ? "No trips match your search." : "No trips saved yet.";
        cell.style.fontSize = "0.9rem";
        cell.style.color = "#6b7280";
        row.appendChild(cell);
        tripsTableBody.appendChild(row);
        return;
      }

      filtered.forEach(trip => {
        if (trip.tripCode) usedTripCodes.add(trip.tripCode);

        const row = document.createElement("tr");
        row.dataset.tripCode = trip.tripCode;

        // Status cell
        const statusTd = document.createElement("td");
        const dot = document.createElement("span");
        const status = trip.status || "active";
        let statusClass;
        if (status === "closed") statusClass = "closed";
        else if ((trip.estimatedProfit || 0) < 0) statusClass = "loss";
        else statusClass = "active";
        dot.className = "status-dot " + statusClass;
        statusTd.appendChild(dot);
        row.appendChild(statusTd);

        const routeText = `${(trip.routeFrom||"")} ‚Üí ${(trip.routeTo||"")}`;

        // compute amount used & left
        const used = calculateAmountUsed(trip);
        const left = calculateAmountLeft(trip);

        const cells = [
          trip.tripCode,
          routeText,
          trip.startDate || "",
          formatCurrency(trip.totalTransportCost || 0),
          formatCurrency(trip.estimatedTripCost || 0),
          formatCurrency(used),         // Amount Used
          formatCurrency(left),         // Amount Left
          formatCurrency(trip.estimatedProfit || 0),
          formatCurrency(trip.pendingFromClient || 0)
        ];

        // push cells: TripCode, Route, StartDate, TotalCost, EstCost, AmountUsed, AmountLeft, EstProfit, Pending
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          row.appendChild(td);
        });

        // Actions column
        const actionsTd = document.createElement("td");
        if (status === "closed") {
          actionsTd.textContent = "Closed";
          actionsTd.style.fontSize = "0.8rem";
          actionsTd.style.color = "#6b7280";
        } else {
          const updateBtn = document.createElement("button");
          updateBtn.className = "btn-ghost btn-small";
          updateBtn.textContent = "Update";
          updateBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            updateTrip(trip.tripCode);
          });

          const closeBtn = document.createElement("button");
          closeBtn.className = "btn-ghost btn-small";
          closeBtn.textContent = "Close trip";
          closeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            closeTrip(trip.tripCode);
          });

          actionsTd.appendChild(updateBtn);
          actionsTd.appendChild(closeBtn);
        }
        row.appendChild(actionsTd);

        tripsTableBody.appendChild(row);
      });
    }

    // ---------- Close trip ----------
    async function closeTrip(tripCode) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      trips[idx].status = "closed";
      trips[idx].syncStatus = "pending";
      saveTrips(trips);
      await saveTrip(trips[idx]); // saveTrip will attempt to sync (silently on network errors)
      renderActiveTrips();
      renderTripsTable();
      showToast("Trip closed.", "info");
    }

    // ---------- Navigation / UI helpers (unchanged) ----------
    function showHome() {
      modeScreen.classList.remove("hidden");
      mainLayout.classList.add("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.add("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openUpdatePage(tripCode) {
      const trips = getStoredTrips();
      const trip = trips.find(t => t.tripCode === tripCode);
      if (!trip) {
        showToast("Trip not found.", "error");
        return;
      }
      currentUpdateTripCode = tripCode;

      updateTripCodeTag.textContent = trip.tripCode || "TRIP";
      const routeText = (trip.routeFrom || "") + " ‚Üí " + (trip.routeTo || "");
      updateRouteDisplay.textContent = routeText || "‚Äî";
      updateStartDateDisplay.textContent = trip.startDate || "‚Äî";
      updatePendingDisplay.textContent = formatCurrency(trip.pendingFromClient || 0);

      renderTxnsForTrip(trip);

      modeScreen.classList.add("hidden");
      mainLayout.classList.add("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.remove("hidden");
      headerViewHistoryBtn.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function updateTrip(tripCode) {
      openUpdatePage(tripCode);
    }

    // ---------- Render txn UI (includes payments) ----------
    function renderTxnsForTrip(trip) {
      ensureTripTransactions(trip);
      txnsGrid.innerHTML = "";

      CATEGORIES.forEach(cat => {
        const block = document.createElement("div");
        block.className = "category-block";

        const head = document.createElement("div");
        head.className = "category-head";
        const label = document.createElement("div");
        label.innerHTML = `<strong>${cat.label}</strong>`;
        const total = document.createElement("div");
        total.className = "category-total";
        total.textContent = formatCurrency(sumCategory(trip, cat.key));
        head.appendChild(label);
        head.appendChild(total);

        const inputs = document.createElement("div");
        inputs.className = "small-inputs";
        const amt = document.createElement("input");
        amt.type = "number";
        amt.min = "0";
        amt.step = "0.01";
        amt.placeholder = "Amount";
        amt.id = `txn_${cat.key}_amt`;

        const dt = document.createElement("input");
        dt.type = "date";
        dt.id = `txn_${cat.key}_date`;
        dt.value = todayISO();

        const addBtn = document.createElement("button");
        addBtn.className = "btn-primary btn-small";
        addBtn.textContent = "Add";
        addBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const a = toNumber(amt.value);
          const d = dt.value || todayISO();
          if (a <= 0) {
            showToast("Enter an amount greater than 0 to add.", "error");
            return;
          }
          addTransactionToTrip(currentUpdateTripCode, cat.key, { amount: a, date: d });
          amt.value = "";
          dt.value = todayISO();
        });

        inputs.appendChild(amt);
        inputs.appendChild(dt);
        inputs.appendChild(addBtn);

        const list = document.createElement("div");
        list.className = "txn-list";
        list.id = `txn_list_${cat.key}`;

        const entries = trip.transactions && trip.transactions[cat.key] ? trip.transactions[cat.key] : [];
        if (!entries.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "No entries yet.";
          list.appendChild(p);
        } else {
          entries.slice().reverse().forEach(entry => {
            const row = buildTxnRow(trip.tripCode, cat.key, entry);
            list.appendChild(row);
          });
        }

        block.appendChild(head);
        block.appendChild(inputs);
        block.appendChild(list);
        txnsGrid.appendChild(block);
      });

      // payments block (optional)
      const paymentsBlock = document.createElement("div");
      paymentsBlock.className = "category-block";
      paymentsBlock.innerHTML = `<div class="category-head"><div><strong>Payments received</strong></div><div class="category-total">${formatCurrency(calculatePaymentsSum(trip))}</div></div>`;
      const payInputs = document.createElement("div");
      payInputs.className = "small-inputs";
      const payAmt = document.createElement("input"); payAmt.type="number"; payAmt.placeholder="Amount"; payAmt.id="pay_amt";
      const payDate = document.createElement("input"); payDate.type="date"; payDate.value = todayISO(); payDate.id="pay_date";
      const payAdd = document.createElement("button"); payAdd.className="btn-primary btn-small"; payAdd.textContent="Add";
      payAdd.addEventListener("click",(e)=>{
        e.preventDefault(); const a = toNumber(payAmt.value); const d = payDate.value || todayISO();
        if (a <= 0) { showToast("Enter an amount greater than 0 to add payment.", "error"); return; }
        addPaymentToTrip(currentUpdateTripCode, { amount: a, date: d });
        payAmt.value = ""; payDate.value = todayISO();
      });
      payInputs.appendChild(payAmt); payInputs.appendChild(payDate); payInputs.appendChild(payAdd);
      paymentsBlock.appendChild(payInputs);

      const payList = document.createElement("div"); payList.className="txn-list";
      const payments = trip.payments && trip.payments.length ? trip.payments.slice().reverse() : [];
      if (!payments.length) { const p = document.createElement("div"); p.className="muted"; p.textContent="No payments yet."; payList.appendChild(p); }
      else {
        payments.forEach(entry => {
          const r = document.createElement("div"); r.className="txn-row";
          r.innerHTML = `<div style="font-weight:600">${formatCurrency(entry.amount)}</div><div class="txn-meta">${entry.date || "‚Äî"}</div>`;
          payList.appendChild(r);
        });
      }
      paymentsBlock.appendChild(payList);
      txnsGrid.appendChild(paymentsBlock);
    }

    function buildTxnRow(tripCode, catKey, entry) {
      const row = document.createElement("div");
      row.className = "txn-row";
      row.dataset.txnId = entry.id || "";

      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:600">${formatCurrency(entry.amount)}</div><div class="txn-meta">${entry.date || "‚Äî"}</div>`;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";

      const delBtn = document.createElement("button");
      delBtn.className = "btn-ghost btn-small";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await removeTransactionFromTrip(tripCode, catKey, entry.id);
      });

      right.appendChild(delBtn);
      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    async function addTransactionToTrip(tripCode, catKey, { amount, date }) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      const entry = { id: uid("txn_"), amount: Number(amount), date: date || todayISO() };
      trip.transactions[cat.key ? cat.key : catKey].push(entry);
      updateDerivedCategoryTotals(trip);
      trip.lastUpdated = new Date().toISOString();
      await saveTrip(trip); // saves and syncs
      renderTxnsForTrip(trip);
      updatePendingDisplay.textContent = formatCurrency(trip.pendingFromClient || trip.pending || 0);
      if (trip.tripCode === document.getElementById("tripCode").value) {
        document.getElementById("totalCostDisplay").textContent = formatCurrency(trip.totalTransportCost || 0);
      }
      showToast(`${formatCurrency(amount)} added to ${catKey}.`, "success");
    }

    async function removeTransactionFromTrip(tripCode, catKey, txnId) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      const beforeLen = trip.transactions[catKey].length;
      trip.transactions[catKey] = trip.transactions[catKey].filter(x => x.id !== txnId);
      if (trip.transactions[catKey].length === beforeLen) {
        showToast("Transaction not found.", "error");
        return;
      }
      updateDerivedCategoryTotals(trip);
      trip.lastUpdated = new Date().toISOString();
      await saveTrip(trip);
      renderTxnsForTrip(trip);
      showToast("Transaction removed.", "info");
    }

    async function addPaymentToTrip(tripCode, { amount, date }) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) { showToast("Trip not found.", "error"); return; }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      trip.payments.push({ id: uid("pay_"), amount: Number(amount), date: date || todayISO() });
      trip.lastUpdated = new Date().toISOString();
      trip.pendingFromClient = (toNumber(trip.totalTransportCost || 0)) - (toNumber(trip.advancePaid || 0) + calculatePaymentsSum(trip));
      await saveTrip(trip);
      renderTxnsForTrip(trip);
      showToast(`${formatCurrency(amount)} recorded as payment.`, "success");
    }

    // ---------- Safe fetch + merge (silent on network) ----------
    async function fetchTripsFromServer() {
      if (!API_BASE) {
        return;
      }
      try {
        const res = await fetch(API_BASE + "/trips");
        if (!res.ok) {
          console.warn("fetchTripsFromServer: status", res.status);
          return;
        }
        const serverTrips = await res.json();
        if (!Array.isArray(serverTrips)) {
          console.warn("Unexpected server response for /trips", serverTrips);
          return;
        }
        const local = getStoredTrips();
        const map = new Map(local.map(t => [t.tripCode, t]));
        serverTrips.forEach(st => { if (!st.tripCode) return; st.syncStatus = "ok"; map.set(st.tripCode, st); });
        const merged = Array.from(map.values());
        saveTrips(merged);
        showToast("Fetched trips from server.", "success");
        renderTripsTable();
        renderActiveTrips();
      } catch (err) {
        console.warn("Silent fetch error:", err);
      }
    }

    // ---------- CSV export / import (includes transactions & payments) ----------
    function csvEscape(v) {
      if (v === null || v === undefined) return "";
      const s = String(v);
      if (s.includes(",") || s.includes('"') || s.includes("\n")) {
        return '"' + s.replaceAll('"', '""') + '"';
      }
      return s;
    }

    function exportCsv() {
      const trips = getStoredTrips();
      if (!trips.length) { showToast("No trips to export.", "info"); return; }
      const headers = ["tripCode","startDate","routeFrom","routeTo","totalTransportCost","estimatedTripCost","estimatedProfit","advancePaid","advancePaidDate","pendingFromClient","amountUsed","amountLeft","status","lastUpdated","transactions_json","payments_json"];
      const rows = trips.map(t => {
        const txnsJson = JSON.stringify(t.transactions || {});
        const paysJson = JSON.stringify(t.payments || []);
        const amountUsed = calculateAmountUsed(t);
        const amountLeft = calculateAmountLeft(t);
        return headers.map(h => csvEscape(h === "transactions_json" ? txnsJson : (h === "payments_json" ? paysJson : (h === "amountUsed" ? amountUsed : (h === "amountLeft" ? amountLeft : t[h]))))).join(",");
      });
      const csv = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `trips_export_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("Exported CSV.", "success");
    }

    function parseCsvLine(line) {
      const res = [];
      let cur = "";
      let inQuotes = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i+1] === '"') { cur += '"'; i++; } else inQuotes = false;
          } else cur += ch;
        } else {
          if (ch === ',') { res.push(cur); cur = ""; } else if (ch === '"') { inQuotes = true; } else cur += ch;
        }
      }
      res.push(cur);
      return res;
    }

    function importCsv(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (!lines.length) { showToast("CSV empty.", "error"); return; }
      const header = parseCsvLine(lines[0]);
      const rows = lines.slice(1).map(l => parseCsvLine(l));
      const items = rows.map(r => {
        const obj = {};
        for (let i=0;i<header.length;i++){ const key = header[i]; obj[key] = r[i] ?? ""; }
        obj.totalTransportCost = toNumber(obj.totalTransportCost);
        obj.estimatedTripCost = toNumber(obj.estimatedTripCost);
        obj.estimatedProfit = toNumber(obj.estimatedProfit);
        obj.advancePaid = toNumber(obj.advancePaid);
        obj.pendingFromClient = toNumber(obj.pendingFromClient);
        obj.lastUpdated = obj.lastUpdated || new Date().toISOString();
        try { obj.transactions = obj.transactions_json ? JSON.parse(obj.transactions_json) : {}; } catch { obj.transactions = {}; }
        try { obj.payments = obj.payments_json ? JSON.parse(obj.payments_json) : []; } catch { obj.payments = []; }
        if (!obj.tripCode) obj.tripCode = generateTripCode(obj.startDate || todayISO());
        return obj;
      });
      const local = getStoredTrips();
      const map = new Map(local.map(t => [t.tripCode, t]));
      items.forEach(it => map.set(it.tripCode, it));
      const merged = Array.from(map.values());
      saveTrips(merged);
      renderTripsTable();
      renderActiveTrips();
      showToast("Imported CSV and merged trips.", "success");
    }

    exportCsvBtn.addEventListener("click", exportCsv);
    importCsvInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try { const text = await file.text(); importCsv(text); } catch (err) { console.error(err); showToast("Failed to read CSV file.", "error"); } finally { importCsvInput.value = ""; }
    });

    // ---------- Init ----------
    (async function init() {
      await fetchTripsFromServer(); // silent on failure
      const existing = getStoredTrips();
      existing.forEach(t => { if (t.tripCode) usedTripCodes.add(t.tripCode); });
      renderTripsTable();
      renderActiveTrips();
    })();

    // ---------- Misc UI handlers ----------
    updateBackBtn.addEventListener("click", () => showHome());
    updateDoneBtn.addEventListener("click", () => { renderTripsTable(); renderActiveTrips(); showHome(); showToast("Done updating transactions.", "success"); });

    modeNewTripBtn.addEventListener("click", () => {
      modeScreen.classList.add("hidden");
      mainLayout.classList.remove("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    modeViewHistoryBtn.addEventListener("click", () => {
      modeScreen.classList.add("hidden");
      mainLayout.classList.add("hidden");
      updateCard.classList.add("hidden");
      tripsListCard.classList.remove("hidden");
      headerViewHistoryBtn.classList.add("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    headerHomeBtn.addEventListener("click", showHome);
    historyNewTripBtn.addEventListener("click", () => {
      modeScreen.classList.add("hidden");
      mainLayout.classList.remove("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.remove("hidden");
      document.getElementById("tripForm").reset();
      tripCodeInput.value = "";
      step2.classList.remove("active"); step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2"; stepIndicator.textContent = "Route details";
      advanceDateGroup.style.display = "none";
      resetSummary();
    });

    historySearch.addEventListener("input", renderTripsTable);

    // NEXT (Step 1 -> Step 2)
    nextStepBtn.addEventListener("click", () => {
      const routeFrom = document.getElementById("routeFrom").value.trim();
      const routeTo = document.getElementById("routeTo").value.trim();
      const startDate = document.getElementById("startDate").value;

      if (!routeFrom || !routeTo || !startDate) {
        showToast("Please fill From, To and Start date to continue.", "error");
        return;
      }

      if (!tripCodeInput.value) {
        const code = generateTripCode(startDate);
        tripCodeInput.value = code;
        document.getElementById("tripCodeDisplay").textContent = code || "‚Äî";
      }

      const routeText = routeFrom + " ‚Üí " + routeTo;
      document.getElementById("routeDisplay").textContent = routeText;
      document.getElementById("startDateDisplay").textContent = startDate || "‚Äî";
      document.getElementById("summaryTitle").textContent =
        routeText + " ‚Ä¢ " + (startDate || "");

      step1.classList.remove("active");
      step2.classList.add("active");
      stepPill.textContent = "Step 2 of 2";
      stepIndicator.textContent = "Cost details";
    });

    // BACK (Step 2 -> Step 1)
    backStepBtn.addEventListener("click", () => {
      step2.classList.remove("active");
      step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2";
      stepIndicator.textContent = "Route details";
    });

    // RESET
    resetBtn.addEventListener("click", () => {
      tripCodeInput.value = "";
      step2.classList.remove("active");
      step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2";
      stepIndicator.textContent = "Route details";
      advanceDateGroup.style.display = "none";
      resetSummary();
    });

    // Show/hide advance date
    advancePaidInput.addEventListener("input", () => {
      const val = toNumber(advancePaidInput.value);
      if (val > 0) {
        advanceDateGroup.style.display = "block";
      } else {
        advanceDateGroup.style.display = "none";
        document.getElementById("advancePaidDate").value = "";
      }
    });

    // New Trip button in summary
    newTripBtn.addEventListener("click", () => {
      document.getElementById("tripForm").reset();
      tripCodeInput.value = "";
      step2.classList.remove("active");
      step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2";
      stepIndicator.textContent = "Route details";
      advanceDateGroup.style.display = "none";
      resetSummary();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Edit button in summary
    editTripBtn.addEventListener("click", () => {
      formCard.classList.remove("hidden");
      summaryCard.classList.remove("summary-full");
      summaryCard.classList.add("summary-small");
      newTripBtn.classList.add("hidden");
      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
      step1.classList.remove("active");
      step2.classList.add("active");
      stepPill.textContent = "Step 2 of 2";
      stepIndicator.textContent = "Cost details";
    });

    // Save button in summary
    summarySaveBtn.addEventListener("click", () => {
      document.getElementById("tripForm").requestSubmit();
    });

    // View saved record button
    viewSavedRecordBtn.addEventListener("click", () => {
      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
      newTripBtn.classList.remove("hidden");
    });

    // SUBMIT main Trip form
    document.getElementById("tripForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const routeFrom = document.getElementById("routeFrom").value.trim();
      const routeTo = document.getElementById("routeTo").value.trim();
      const startDate = document.getElementById("startDate").value;
      const totalCost = toNumber(document.getElementById("totalCost").value);
      const estimatedCost = toNumber(document.getElementById("estimatedCost").value);
      const advancePaid = toNumber(document.getElementById("advancePaid").value);
      const advancePaidDate = document.getElementById("advancePaidDate").value;
      let tripCode = tripCodeInput.value;

      if (!tripCode) {
        tripCode = generateTripCode(startDate);
        tripCodeInput.value = tripCode;
      }

      const profit = totalCost - estimatedCost;
      const pending = totalCost - advancePaid;

      const routeText = routeFrom + " ‚Üí " + routeTo;

      document.getElementById("tripCodeDisplay").textContent = tripCode || "‚Äî";
      document.getElementById("routeDisplay").textContent = routeText || "‚Äî";
      document.getElementById("startDateDisplay").textContent = startDate || "‚Äî";
      document.getElementById("totalCostDisplay").textContent = formatCurrency(totalCost);
      document.getElementById("estimatedCostDisplay").textContent = formatCurrency(estimatedCost);
      document.getElementById("profitDisplay").textContent = formatCurrency(profit);
      document.getElementById("advanceDisplay").textContent = formatCurrency(advancePaid);
      document.getElementById("pendingDisplay").textContent = formatCurrency(pending);
      document.getElementById("advanceDateDisplay").textContent =
        advancePaid > 0 && advancePaidDate ? advancePaidDate : "‚Äî";

      document.getElementById("summaryStatus").textContent = "Saved";

      const profitDisplay = document.getElementById("profitDisplay");
      const profitBadgeText = document.getElementById("profitBadgeText");
      const pendingBadgeText = document.getElementById("pendingBadgeText");

      profitDisplay.classList.remove("positive", "negative");
      if (profit > 0) {
        profitDisplay.classList.add("positive");
        profitBadgeText.textContent = "Trip is in estimated profit (total > estimated cost)";
      } else if (profit < 0) {
        profitDisplay.classList.add("negative");
        profitBadgeText.textContent = "Trip is in estimated loss (estimated cost > total)";
      } else {
        profitBadgeText.textContent = "Estimated break-even trip";
      }

      if (pending > 0) {
        pendingBadgeText.textContent = "Client has pending payment";
      } else if (pending < 0) {
        pendingBadgeText.textContent = "Extra amount received";
      } else {
        pendingBadgeText.textContent = "Fully paid";
      }

      document.getElementById("summaryTitle").textContent =
        (tripCode ? tripCode + " ‚Ä¢ " : "") +
        routeText +
        (startDate ? " ‚Ä¢ " + startDate : "");

      const existing = getStoredTrips().find(t => t.tripCode === tripCode);
      const status = existing ? (existing.status || "active") : "active";

      const payload = {
        ...(existing || {}),
        tripCode,
        routeFrom,
        routeTo,
        startDate,
        totalTransportCost: totalCost,
        estimatedTripCost: estimatedCost,
        estimatedProfit: profit,
        advancePaid,
        advancePaidDate: advancePaidDate || null,
        pendingFromClient: pending,
        status,
        lastUpdated: new Date().toISOString()
      };

      if (existing && existing.transactions) payload.transactions = existing.transactions;
      if (existing && existing.payments) payload.payments = existing.payments;

      await saveTrip(payload);

      renderTripsTable();
      renderActiveTrips();

      formCard.classList.add("hidden");
      summaryCard.classList.remove("summary-small");
      summaryCard.classList.add("summary-full");
      summaryContent.classList.add("hidden");
      savedMessage.classList.remove("hidden");
      newTripBtn.classList.add("hidden");
    });

    // ensure date default is today when adding new txns ‚Äî handled when rendering inputs
  </script>
</body>
</html>
