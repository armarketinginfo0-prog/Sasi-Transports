<!-- PART 1: Up to and including the marker "// ---------- Safe fetch + merge (silent on network) ----------" -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sasi Kumar Transports ‚Äî Trip Manager</title>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0f172a;
      --card-bg: #0b1220;
      --card-bg-soft: #020617;
      --primary: #2563eb;
      --primary-soft: #1d4ed8;
      --primary-soft-strong: #60a5fa;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #f87171;
      --danger-soft: rgba(248, 113, 113, 0.08);
      --success: #34d399;
      --success-soft: rgba(52, 211, 153, 0.08);
      --warning-soft: rgba(251, 191, 36, 0.08);
      --radius: 14px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Base layout */
    body {
      background:
        radial-gradient(circle at top, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at bottom, rgba(59, 130, 246, 0.2), transparent 60%),
        linear-gradient(to bottom, #020617, #020617);
      color: var(--text-main);
      min-height: 100vh;
      padding: 18px 12px 32px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Simple fade / slide animation */
    .fade-in {
      animation: fadeInUp 0.4s ease-out;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* SIDEBAR (scaffold, collapsible) */
    .app-shell {
      display: flex;
      gap: 16px;
    }
    .sidebar {
      width: 72px; /* collapsed by default; part 2 will wire toggle */
      min-width: 72px;
      background: linear-gradient(180deg,#071026,#030512);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      border: 1px solid rgba(148,163,184,0.06);
      transition: width 0.18s ease;
    }
    .sidebar.expanded { width: 220px; min-width: 220px; padding: 14px; }
    .sidebar .logo { font-weight: 700; letter-spacing: 0.02em; font-size: 0.95rem; color: var(--text-main); margin-bottom: 4px; }
    .sidebar .nav-btn { width: 100%; display:flex; align-items:center; gap:10px; border-radius: 10px; padding: 8px 10px; cursor:pointer; color: var(--text-main); background: transparent; border: none; text-align:left; }
    .sidebar .nav-btn:hover { background: rgba(37,99,235,0.08); transform: translateY(-2px); }

    /* NAV BAR */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding: 10px 16px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #1e293b, #020617);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.35);
      position: sticky;
      top: 8px;
      z-index: 20;
      backdrop-filter: blur(16px);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    header p {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.16), transparent 60%),
                  linear-gradient(145deg, var(--card-bg), var(--card-bg-soft));
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.16), transparent 60%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .card.hover-card:hover::before {
      opacity: 1;
    }

    .card.hover-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.7);
      border-color: rgba(129, 140, 248, 0.7);
    }

    .form-card {
      flex: 2;
    }

    .summary-card-wrapper {
      flex: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.14);
      color: #bfdbfe;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      border: 1px solid rgba(129, 140, 248, 0.5);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin: 4px 0 4px;
      opacity: 0.9;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 6px;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    input, select, textarea {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease, transform 0.08s ease;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      width: 100%;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.45);
      background: #020617;
      transform: translateY(-0.5px);
    }

    input[type="date"] {
      padding-inline: 10px;
    }

    select {
      cursor: pointer;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) 50%, calc(100% - 9px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }

    input[readonly] {
      background: #020617;
      cursor: default;
      opacity: 0.8;
    }

    .muted {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      padding: 9px 18px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, border-color 0.12s ease, color 0.12s ease;
    }

    .btn-primary {
      background-image: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #e5f0ff;
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.55);
      border: 1px solid rgba(191, 219, 254, 0.7);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 38px rgba(37, 99, 235, 0.8);
      background-image: linear-gradient(135deg, #1d4ed8, #4338ca);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.7);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #60a5fa;
      color: #bfdbfe;
    }

    .btn-outline:hover {
      background: rgba(37, 99, 235, 0.18);
      color: #e5f0ff;
      transform: translateY(-1px);
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    .btn-large {
      padding: 14px 24px;
      font-size: 1rem;
      border-radius: 999px;
      justify-content: center;
      width: 100%;
    }

    .summary-card {
      min-width: 0;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .summary-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .summary-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .summary-item {
      border-radius: 10px;
      padding: 8px 10px;
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), transparent 60%);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 2px;
    }

    .summary-value.positive {
      color: var(--success);
    }

    .summary-value.negative {
      color: var(--danger);
    }

    .summary-footer {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.45);
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .summary-footer-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .badge-dot.profit {
      background: var(--success);
    }

    .badge-dot.loss {
      background: var(--danger);
    }

    .badge-dot.pending {
      background: #fbbf24;
    }

    .tip {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tip strong {
      color: var(--text-main);
    }

    .step {
      display: none;
    }
    .step.active {
      display: block;
    }

    .step-indicator {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    .summary-small {
      opacity: 0.9;
      transform: scale(0.98);
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .summary-full {
      max-width: 900px;
      margin: 0 auto;
      transform: scale(1);
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .summary-full .summary-title {
      font-size: 1.1rem;
    }

    .summary-full .summary-grid .summary-item {
      padding: 10px 12px;
    }

    /* Saved message */
    .saved-message {
      margin-top: 12px;
      text-align: center;
      font-size: 0.9rem;
    }

    .saved-message p {
      margin-bottom: 8px;
      color: var(--text-muted);
    }

    /* Trips table */
    .table-wrapper {
      margin-top: 10px;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.65), rgba(15, 23, 42, 0.98));
    }

    .trips-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 900px;
    }

    .trips-table thead {
      background: linear-gradient(to right, #111827, #020617);
    }

    .trips-table th,
    .trips-table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      text-align: left;
      white-space: nowrap;
    }

    .trips-table th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(10px);
    }

    .trips-table td {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .trips-table tbody tr {
      transition: background 0.12s ease, transform 0.08s ease;
    }

    .trips-table tbody tr:hover {
      background: rgba(37, 99, 235, 0.22);
      cursor: pointer;
      transform: translateY(-1px);
    }

    /* Row colour coding */
    .trip-row.closed {
      background-color: rgba(31, 41, 55, 0.85);
    }
    .trip-row.loss {
      background-color: var(--danger-soft);
    }
    .trip-row.profit {
      background-color: var(--success-soft);
    }

    /* Mode screen */
    .mode-card {
      margin-top: 8px;
      text-align: center;
    }

    .mode-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mode-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .mode-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 420px;
      margin: 0 auto;
      margin-top: 8px;
    }

    @media (min-width: 600px) {
      .mode-actions {
        flex-direction: row;
      }
    }

    /* History header controls */
    .history-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .history-search-input {
      min-width: 180px;
      max-width: 260px;
    }

    .history-search-input input {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.85rem;
    }

    .history-date-filters {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .history-date-filters input[type="date"] {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.78rem;
    }

    .history-summary-bar {
      margin-top: 6px;
      margin-bottom: 4px;
      padding: 8px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at left, rgba(37, 99, 235, 0.3), rgba(15, 23, 42, 0.95));
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.8rem;
      color: #e5e7eb;
      justify-content: space-between;
      border: 1px solid rgba(37, 99, 235, 0.6);
    }

    .history-summary-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(156, 163, 175, 0.7);
    }

    /* Status dot + chip */
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      display: inline-block;
    }

    .status-dot.active {
      background: #22c55e;
    }

    .status-dot.closed {
      background: #6b7280;
    }

    .status-dot.loss {
      background: #f97373;
    }

    .status-chip {
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #4b5563;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
    }

    .status-chip.closed {
      background: rgba(31, 41, 55, 0.95);
      color: #d1d5db;
      border-color: #6b7280;
    }
    .status-chip.loss {
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.6);
    }
    .status-chip.active {
      background: rgba(22, 163, 74, 0.2);
      color: #bbf7d0;
      border-color: rgba(22, 163, 74, 0.6);
    }

    /* Active trips card */
    .active-card {
      margin-top: 16px;
      text-align: left;
    }

    .active-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .active-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
      font-size: 0.9rem;
    }

    .active-item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .active-item-text {
      display: flex;
      flex-direction: column;
    }

    .active-item-route {
      font-weight: 600;
    }

    .active-item-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      margin-top: -4px;
    }

    .filter-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.75rem;
      cursor: pointer;
      color: #e5e7eb;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease, transform 0.1s ease;
    }

    .filter-pill:hover {
      border-color: #60a5fa;
      transform: translateY(-0.5px);
    }

    .filter-pill.active {
      background: linear-gradient(to right, #2563eb, #4f46e5);
      border-color: #93c5fd;
      color: #e5f0ff;
    }

    /* Vehicle summary card */
    .vehicle-summary-grid {
      display: grid;
      gap: 8px;
      margin-top: 4px;
    }

    @media (min-width: 700px) {
      .vehicle-summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .vehicle-card {
      border-radius: 10px;
      padding: 8px 10px;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.4), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(129, 140, 248, 0.7);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .vehicle-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .vehicle-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .vehicle-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 0.7rem;
    }

    /* Update page (incremental) */
    .update-layout {
      max-width: 900px;
      margin: 0 auto;
      margin-top: 8px;
    }

    .txns-grid {
      display: grid;
      gap: 12px;
    }
    @media(min-width:900px){ .txns-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

    .category-block {
      border: 1px solid rgba(129, 140, 248, 0.5);
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.2), rgba(15, 23, 42, 0.98));
      padding: 10px;
      border-radius: 10px;
    }

    .category-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .category-total{font-weight:700;color:var(--text-main)}
    .txn-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .txn-row{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#020617;border:1px solid #1f2937}
    .txn-meta{font-size:0.92rem;color:var(--text-muted)}
    .txn-actions button{border-radius:8px;padding:6px 8px;border:1px solid #4b5563;background:transparent;cursor:pointer}

    .small-inputs{display:flex;gap:8px;align-items:center}
    .small-inputs input[type="number"]{width:110px;border-radius:8px}
    .small-inputs input[type="date"]{width:150px;border-radius:8px}
    .small-inputs button{white-space:nowrap}

    .update-footer { margin-top:10px; display:flex; gap:8px; justify-content:flex-end; }

    /* Toast (upgraded) */
    #toast-container {
      position: fixed;
      right: 16px;
      bottom: 18px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.8);
      min-width: 220px;
      font-size: 0.95rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      gap: 8px;
      align-items: center;
      pointer-events: auto;
      transform: translateY(10px);
      opacity: 0;
      animation: toastIn 0.28s forwards;
    }
    @keyframes toastIn {
      to { transform: translateY(0); opacity: 1; }
    }
    .toast .toast-icon { width: 22px; height: 22px; display:inline-flex; align-items:center; justify-content:center; font-size:14px; }
    .toast .toast-close { margin-left:auto; background:transparent; border:none; color:inherit; cursor:pointer; font-weight:700; font-size:14px; padding:4px; border-radius:6px; }
    .toast.success { background: linear-gradient(90deg,#047857,#22c55e); color: #04210a; }
    .toast.error { background: linear-gradient(90deg,#b91c1c,#f97373); color: #330505; }
    .toast.info { background: linear-gradient(90deg,#0f172a,#1f2937); color: #e5e7eb; }

    /* small file input style */
    .file-input {
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .file-input input[type=file] { display:none; }

    /* Responsive tweaks */
    @media (max-width: 900px) {
      .vehicle-summary-grid { grid-template-columns: 1fr; }
      .trips-table { min-width: 700px; }
      .txns-grid { grid-template-columns: 1fr; }

      /* mobile improvements foundations */
      header { padding: 10px; border-radius: 12px; }
      .btn-large { padding: 12px 16px; font-size: 0.95rem; }
      .sidebar { display: none; } /* sidebar hidden on small screens; part 2 will add mobile toggle */
    }

    /* Sticky bottom nav scaffold for mobile */
    .mobile-bottom-nav {
      display: none;
    }
    @media (max-width: 600px) {
      .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 8px;
        left: 8px;
        right: 8px;
        justify-content: space-around;
        gap: 8px;
        padding: 8px;
        border-radius: 12px;
        background: rgba(2,6,23,0.95);
        border: 1px solid rgba(148,163,184,0.06);
        z-index: 60;
      }
      .mobile-bottom-nav button { flex: 1; padding: 10px; border-radius: 10px; font-weight:600; }
    }

  </style>
</head>
<body>
  <div class="page fade-in">
    <!-- NAV BAR -->
    <header>
      <div class="header-left">
        <h1>Sasi Kumar Transports</h1>
        <p>Trip manager ‚Äî create, track and close your transport trips.</p>
      </div>
      <div class="header-actions">
        <button class="btn-ghost" id="headerHomeBtn">üè† Home</button>
        <button class="btn-outline hidden" id="headerViewHistoryBtn">üìú View history</button>

        <!-- CSV export / import controls added -->
        <button class="btn-ghost btn-small" id="exportCsvBtn" title="Export trips as CSV">‚¨áÔ∏è Export CSV</button>
        <label class="file-input btn-ghost btn-small" title="Import trips from CSV">
          ‚¨ÜÔ∏è Import CSV
          <input type="file" id="importCsvInput" accept=".csv,text/csv" />
        </label>
      </div>
    </header>

    <!-- HOME: New Trip / View history + Active trip list + Vehicle summary -->
    <div class="card mode-card hover-card" id="modeScreen">
      <div class="mode-title">What do you want to do?</div>
      <div class="mode-subtitle">Choose an option below to get started.</div>
      <div class="mode-actions">
        <button class="btn-primary btn-large" id="modeNewTripBtn">
          ‚ûï New Trip
        </button>
        <button class="btn-outline btn-large" id="modeViewHistoryBtn">
          üìú View history
        </button>
      </div>

      <!-- Active trip list on home -->
      <div class="card active-card hover-card" id="activeTripsCard">
        <div class="card-header" style="margin-bottom:6px;">
          <h2>Active trips</h2>
        </div>
        <div class="active-filters" id="activeVehicleFilters">
          <button class="filter-pill active" data-vehicle="">All</button>
          <button class="filter-pill" data-vehicle="TN 52 Af 0913.con">TN 52 Af 0913.con</button>
          <button class="filter-pill" data-vehicle="TN 54 AA 7528">TN 54 AA 7528</button>
          <button class="filter-pill" data-vehicle="TN 47 AQ 4046">TN 47 AQ 4046</button>
          <button class="filter-pill" data-vehicle="TN 09 CZ 3667">TN 09 CZ 3667</button>
        </div>
        <div class="active-list" id="activeTripsBody">
          <!-- Filled by JS -->
        </div>
      </div>

      <!-- Vehicle summary on home -->
      <div class="card active-card hover-card" id="vehicleSummaryCard">
        <div class="card-header" style="margin-bottom:6px;">
          <h2>Vehicle summary</h2>
        </div>
        <div class="vehicle-summary-grid" id="vehicleSummaryBody">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>

    <!-- MAIN LAYOUT (New Trip mode: form + summary) -->
    <div class="layout hidden" id="mainLayout">
      <!-- LEFT: BIG FORM -->
      <div class="card form-card hover-card" id="formCard">
        <div class="card-header">
          <h2>
            Trip Entry
            <span class="pill" id="stepPill">Step 1 of 2</span>
          </h2>
          <span class="step-indicator" id="stepIndicator">Route details</span>
        </div>

        <form id="tripForm">
          <!-- STEP 1 -->
          <div class="step active" id="step1">
            <div class="section-title">Route details</div>

            <div class="field-group">
              <div class="input-group">
                <label for="routeFrom">From (state / district)</label>
                <input list="locationList" id="routeFrom" placeholder="Type and select..." required />
              </div>
              <div class="input-group">
                <label for="routeTo">To (state / district)</label>
                <input list="locationList" id="routeTo" placeholder="Type and select..." required />
              </div>
              <div class="input-group">
                <label for="startDate">Start date</label>
                <input type="date" id="startDate" required />
              </div>
              <div class="input-group">
                <label for="vehicle">Vehicle</label>
                <select id="vehicle" required>
                  <option value="">Select vehicle</option>
                  <option value="TN 52 Af 0913.con">TN 52 Af 0913.con</option>
                  <option value="TN 54 AA 7528">TN 54 AA 7528</option>
                  <option value="TN 47 AQ 4046">TN 47 AQ 4046</option>
                  <option value="TN 09 CZ 3667">TN 09 CZ 3667</option>
                </select>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn-primary" id="nextStepBtn">
                Next
              </button>
              <button type="reset" class="btn-ghost" id="resetBtn">
                Clear
              </button>
            </div>
            <p class="tip">
              Step 1: Enter starting details. After this, a <strong>Trip Code</strong> will be generated automatically.
            </p>
          </div>

          <!-- STEP 2 -->
          <div class="step" id="step2">
            <div class="section-title">Trip code & cost details</div>

            <div class="field-group">
              <div class="input-group">
                <label for="tripCode">Trip code (auto-generated)</label>
                <input type="text" id="tripCode" readonly />
              </div>
            </div>

            <div class="field-group">
              <div class="input-group">
                <label for="totalCost">Total transport cost (amount you charge client) (‚Çπ)</label>
                <input type="number" id="totalCost" placeholder="e.g. 50000" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="estimatedCost">Estimated total trip cost (your expected trip expense) (‚Çπ)</label>
                <input type="number" id="estimatedCost" placeholder="e.g. 38000" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="advancePaid">Advance paid (‚Çπ)</label>
                <input type="number" id="advancePaid" placeholder="e.g. 15000" min="0" step="0.01" />
              </div>
              <div class="input-group" id="advanceDateGroup" style="display:none;">
                <label for="advancePaidDate">Advance paid date</label>
                <input type="date" id="advancePaidDate" />
              </div>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">
                Save &amp; Calculate
              </button>
              <button type="button" class="btn-ghost" id="backStepBtn">
                Back
              </button>
            </div>
            <p class="tip">
              Estimated profit = Total transport cost ‚àí Estimated total trip cost.  
              Pending from client = Total transport cost ‚àí Advance.
            </p>
          </div>
        </form>
      </div>

      <!-- RIGHT: SUMMARY -->
      <div class="summary-card-wrapper" id="summaryWrapper">
        <div class="card summary-card summary-small hover-card" id="summaryCard">
          <div class="summary-header">
            <div>
              <div class="summary-title">Trip Summary</div>
              <div class="muted" id="summaryTitle">Fill the form to see totals.</div>
            </div>
            <div class="summary-header-actions">
              <button class="btn-outline hidden" id="newTripBtn">New Trip</button>
              <span class="summary-pill" id="summaryStatus">Preview</span>
            </div>
          </div>

          <!-- Summary content (grid + footer) -->
          <div id="summaryContent">
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Trip code</div>
                <div class="summary-value" id="tripCodeDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Vehicle</div>
                <div class="summary-value" id="vehicleDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Route</div>
                <div class="summary-value" id="routeDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Start date</div>
                <div class="summary-value" id="startDateDisplay">‚Äî</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Total transport cost (client billing)</div>
                <div class="summary-value" id="totalCostDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Estimated total trip cost</div>
                <div class="summary-value" id="estimatedCostDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Estimated profit (total ‚àí est)</div>
                <div class="summary-value" id="profitDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Advance paid</div>
                <div class="summary-value" id="advanceDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Pending from client (total ‚àí advance)</div>
                <div class="summary-value" id="pendingDisplay">‚Çπ0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Advance paid date</div>
                <div class="summary-value" id="advanceDateDisplay">‚Äî</div>
              </div>
            </div>

            <div class="summary-footer">
              <div>
                <div class="badge" id="profitBadge">
                  <span class="badge-dot profit"></span>
                  <span id="profitBadgeText">No profit data yet</span>
                </div>
                <div class="badge">
                  <span class="badge-dot pending"></span>
                  <span id="pendingBadgeText">No pending amount yet</span>
                </div>
              </div>
              <div class="summary-footer-controls">
                <button class="btn-ghost" id="editTripBtn">Edit</button>
                <button class="btn-primary" id="summarySaveBtn">Save</button>
              </div>
            </div>
          </div>

          <!-- Saved message shown after Save -->
          <div class="saved-message hidden" id="savedMessage">
            <p>Record saved, thank you.</p>
            <button class="btn-primary" id="viewSavedRecordBtn">View saved record</button>
          </div>
        </div>
      </div>
    </div>

    <!-- UPDATE PAGE (Incremental) -->
    <div class="card hidden hover-card" id="updateCard">
      <div class="update-layout">
        <div class="card-header">
          <h2>Update Trip (Add new payments & expenses)</h2>
          <span class="pill" id="updateTripCodeTag">TRIP</span>
        </div>

        <div class="update-summary">
          <div><strong>Route:</strong> <span id="updateRouteDisplay">‚Äî</span></div>
          <div><strong>Start date:</strong> <span id="updateStartDateDisplay">‚Äî</span></div>
          <div><strong>Pending from client:</strong> <span id="updatePendingDisplay">‚Çπ0</span></div>
        </div>

        <!-- NEW TRANSACTIONS UI -->
        <div class="section-title">Add dated transactions (all optional)</div>
        <div class="txns-grid" id="txnsGrid">
          <!-- Category blocks will be injected by JS -->
        </div>

        <div class="update-footer">
          <button class="btn-ghost" id="updateBackBtn">Back</button>
          <button class="btn-primary" id="updateDoneBtn">Done</button>
        </div>
      </div>
    </div>

    <!-- SAVED TRIPS LIST (View history) -->
    <div class="card hidden hover-card" id="tripsListCard" style="margin-top:16px;">
      <div class="card-header">
        <h2>Saved Trips (this device)</h2>
        <div class="history-header-right">
          <div class="history-search-input">
            <input
              type="text"
              id="historySearch"
              placeholder="Search by trip code, from, to..."
            />
          </div>
          <div class="history-date-filters">
            <input type="date" id="historyFromDate" />
            <span>to</span>
            <input type="date" id="historyToDate" />
          </div>
          <select id="vehicleFilter">
            <option value="">All vehicles</option>
            <option value="TN 52 Af 0913.con">TN 52 Af 0913.con</option>
            <option value="TN 54 AA 7528">TN 54 AA 7528</option>
            <option value="TN 47 AQ 4046">TN 47 AQ 4046</option>
            <option value="TN 09 CZ 3667">TN 09 CZ 3667</option>
          </select>
          <button class="btn-outline" id="historyNewTripBtn">‚ûï New Trip</button>
        </div>
      </div>
      <div class="history-summary-bar" id="historySummaryBar">
        <span class="history-summary-pill" id="summaryTripsCount">Trips: 0</span>
        <span class="history-summary-pill" id="summaryTotalBilled">Total billed: ‚Çπ0</span>
        <span class="history-summary-pill" id="summaryTotalProfit">Est. profit: ‚Çπ0</span>
        <span class="history-summary-pill" id="summaryTotalPending">Pending: ‚Çπ0</span>
      </div>
      <div class="table-wrapper">
        <table class="trips-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Trip Code</th>
              <th>Route</th>
              <th>Vehicle</th>
              <th>Start Date</th>
              <th>Total Cost</th>
              <th>Est. Cost</th>
              <th>Amount Used</th>
              <th>Amount Left</th>
              <th>Est. Profit</th>
              <th>Pending</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tripsTableBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
      <p class="tip">Tap / click a row to load that trip into the form for editing.</p>
    </div>
  </div>

  <!-- LOCATIONS -->
  <datalist id="locationList">
    <!-- States / UTs -->
    <option value="Andhra Pradesh"></option>
    <option value="Arunachal Pradesh"></option>
    <option value="Assam"></option>
    <option value="Bihar"></option>
    <option value="Chhattisgarh"></option>
    <option value="Goa"></option>
    <option value="Gujarat"></option>
    <option value="Haryana"></option>
    <option value="Himachal Pradesh"></option>
    <option value="Jharkhand"></option>
    <option value="Karnataka"></option>
    <option value="Kerala"></option>
    <option value="Madhya Pradesh"></option>
    <option value="Maharashtra"></option>
    <option value="Manipur"></option>
    <option value="Meghalaya"></option>
    <option value="Mizoram"></option>
    <option value="Nagaland"></option>
    <option value="Odisha"></option>
    <option value="Punjab"></option>
    <option value="Rajasthan"></option>
    <option value="Sikkim"></option>
    <option value="Tamil Nadu"></option>
    <option value="Telangana"></option>
    <option value="Tripura"></option>
    <option value="Uttar Pradesh"></option>
    <option value="Uttarakhand"></option>
    <option value="West Bengal"></option>
    <option value="Andaman and Nicobar Islands"></option>
    <option value="Chandigarh"></option>
    <option value="Dadra and Nagar Haveli and Daman and Diu"></option>
    <option value="Delhi"></option>
    <option value="Jammu and Kashmir"></option>
    <option value="Ladakh"></option>
    <option value="Lakshadweep"></option>
    <option value="Puducherry"></option>

    <!-- Sample cities -->
    <option value="Tamil Nadu - Chennai"></option>
    <option value="Tamil Nadu - Coimbatore"></option>
    <option value="Tamil Nadu - Erode"></option>
    <option value="Tamil Nadu - Tiruppur"></option>
    <option value="Tamil Nadu - Madurai"></option>
    <option value="Tamil Nadu - Salem"></option>
    <option value="Tamil Nadu - Trichy"></option>
    <option value="Tamil Nadu - Hosur"></option>

    <option value="Karnataka - Bengaluru"></option>
    <option value="Karnataka - Mangalore"></option>
    <option value="Karnataka - Mysuru"></option>

    <option value="Maharashtra - Mumbai"></option>
    <option value="Maharashtra - Pune"></option>
    <option value="Gujarat - Ahmedabad"></option>
    <option value="Gujarat - Surat"></option>
    <option value="Delhi - New Delhi"></option>
    <option value="West Bengal - Kolkata"></option>
  </datalist>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
<!-- Supabase JS (UMD build) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
    /* ---------- Utilities ---------- */
    function toNumber(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function formatCurrency(v) {
      return "‚Çπ" + Number(v || 0).toLocaleString("en-IN", { maximumFractionDigits: 2 });
    }

    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }

    function uid(prefix = "") {
      return prefix + Date.now().toString(36) + "-" + Math.floor(Math.random()*10000).toString(36);
    }

    // Known vehicles (for summary etc.)
    const VEHICLES = [
      "TN 52 Af 0913.con",
      "TN 54 AA 7528",
      "TN 47 AQ 4046",
      "TN 09 CZ 3667"
    ];

    // ---------- API / Sync SETTINGS (placeholders) ----------
    // By default same origin. Set to your API base if different.
    const API_BASE = window.location.origin; // change if needed (e.g. "https://api.yoursite.com")
    const SYNC_PLACEHOLDER = {
      supabaseUrl: "", // fill when available
      supabaseKey: ""  // fill when available
    };

    // ---------- Toast UI (upgraded) ----------
    const toastContainer = document.getElementById("toast-container");
    function _createToastElement(msg, type = "info", timeout = 3500) {
      const d = document.createElement("div");
      d.className = "toast " + (type || "info");

      // icon
      const icon = document.createElement("div");
      icon.className = "toast-icon";
      icon.innerHTML = (type === "success") ? "‚úî" : (type === "error") ? "‚úñ" : "‚Ñπ";
      d.appendChild(icon);

      const body = document.createElement("div");
      body.style.flex = "1";
      body.textContent = msg;
      d.appendChild(body);

      const close = document.createElement("button");
      close.className = "toast-close";
      close.innerHTML = "√ó";
      close.addEventListener("click", () => {
        d.style.transition = "opacity 0.18s";
        d.style.opacity = "0";
        setTimeout(() => d.remove(), 180);
      });
      d.appendChild(close);

      // auto remove
      setTimeout(() => {
        d.style.transition = "opacity 0.25s";
        d.style.opacity = "0";
        setTimeout(() => d.remove(), 250);
      }, timeout);

      return d;
    }

    function showToast(msg, type = "info", timeout = 3500) {
      try {
        const el = _createToastElement(msg, type, timeout);
        toastContainer.appendChild(el);
      } catch (e) {
        // fallback to alert if anything goes wrong
        console.warn("toast failed, fallback to alert", e);
        alert(msg);
      }
    }

    // ---------- Storage helpers ----------
    function getStoredTrips() {
      const raw = localStorage.getItem("trips");
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveTrips(trips) {
      localStorage.setItem("trips", JSON.stringify(trips));
    }

    // ---------- Categories (display order & keys) ----------
    const CATEGORIES = [
      { key: "diesel", label: "Diesel charge" },
      { key: "loading", label: "Loading charge" },
      { key: "office", label: "Office commission" },
      { key: "fastag", label: "Fastag fee" },
      { key: "driver", label: "Driver charge" },
      { key: "unloading", label: "Unloading charge" },
      { key: "receiver", label: "Receiver balance" },
      { key: "misc", label: "Miscellaneous" }
    ];

    // ---------- Derived-calculation helpers ----------
    function ensureTripTransactions(trip) {
      if (!trip.transactions || typeof trip.transactions !== "object") trip.transactions = {};
      CATEGORIES.forEach(c => { if (!Array.isArray(trip.transactions[c.key])) trip.transactions[c.key] = []; });
      if (!Array.isArray(trip.payments)) trip.payments = [];
      // ensure new vehicle-health fields present
      if (!trip.vehicleHealth) trip.vehicleHealth = {};
      const vh = trip.vehicleHealth;
      if (vh.nextServiceKm === undefined) vh.nextServiceKm = null;
      if (vh.nextServiceDate === undefined) vh.nextServiceDate = null;
      if (vh.lastMajorRepair === undefined) vh.lastMajorRepair = null;
      if (vh.insuranceExpiry === undefined) vh.insuranceExpiry = null;
    }

    function sumCategory(trip, catKey) {
      ensureTripTransactions(trip);
      return trip.transactions[catKey].reduce((s, x) => s + (toNumber(x.amount) || 0), 0);
    }

    function calculateAmountUsed(trip) {
      ensureTripTransactions(trip);
      return CATEGORIES.reduce((s, c) => s + sumCategory(trip, c.key), 0);
    }

    function calculatePaymentsSum(trip) {
      ensureTripTransactions(trip);
      return (trip.payments || []).reduce((s, p) => s + (toNumber(p.amount) || 0), 0);
    }

    function calculateAmountLeft(trip) {
      const advance = toNumber(trip.advancePaid || 0);
      const paid = calculatePaymentsSum(trip);
      const used = calculateAmountUsed(trip);
      return (advance + paid) - used;
    }

    function updateDerivedCategoryTotals(trip) {
      ensureTripTransactions(trip);
      trip.dieselCost = sumCategory(trip, "diesel");
      trip.loadingCost = sumCategory(trip, "loading");
      trip.officeCommission = sumCategory(trip, "office");
      trip.fastagCost = sumCategory(trip, "fastag");
      trip.driverCost = sumCategory(trip, "driver");
      trip.unloadingCost = sumCategory(trip, "unloading");
      trip.receiverBalance = sumCategory(trip, "receiver");
      trip.miscCost = sumCategory(trip, "misc");
    }

    // ---------- Audit log helpers ----------
    function getAuditLog() {
      try {
        const raw = localStorage.getItem("audit_log");
        if (!raw) return [];
        return JSON.parse(raw);
      } catch { return []; }
    }
    function addAuditEntry(action, details = {}) {
      const log = getAuditLog();
      log.push({
        id: uid("audit_"),
        ts: new Date().toISOString(),
        action,
        details
      });
      try { localStorage.setItem("audit_log", JSON.stringify(log)); } catch(e) { console.warn("audit save failed", e); }
    }

    // ---------- Sync helper (create/update) ----------
    // IMPORTANT: network failures are SILENCED (no failure toasts)
    async function saveTrip(payload) {
      try {
        const trips = getStoredTrips();
        const idx = trips.findIndex(t => t.tripCode === payload.tripCode);
        if (idx >= 0) trips[idx] = payload;
        else trips.push(payload);
        saveTrips(trips);
      } catch (err) {
        console.error("local save failed", err);
      }

      // add audit entry for save
      addAuditEntry("trip_save", { tripCode: payload.tripCode, status: payload.status || "active" });

      // Attempt server sync but keep network failures silent (only success shows toast)
      if (!API_BASE) {
        payload.syncStatus = "local";
        const trips = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
        saveTrips(trips);
        return;
      }

      try {
        const tripsLocal = getStoredTrips();
        const exists = tripsLocal.some(t => t.tripCode === payload.tripCode);
        const method = exists ? "PUT" : "POST";
        const url = API_BASE + "/trips" + (method === "PUT" ? ("/" + encodeURIComponent(payload.tripCode)) : "");
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          // mark as failed but DO NOT show network failure toast
          payload.syncStatus = "failed";
          const updated = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
          saveTrips(updated);
          console.warn("Sync failed (status)", res.status);
          return;
        }

        const serverObj = await res.json().catch(() => null);
        payload.syncStatus = "ok";
        if (serverObj && typeof serverObj === "object") Object.assign(payload, serverObj);
        const final = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
        saveTrips(final);
        // success toast only
        showToast("Saved & synced to server.", "success");
      } catch (err) {
        // silent on network error ‚Äî keep local copy and mark failed
        console.warn("Silent sync error:", err);
        try {
          payload.syncStatus = "failed";
          const updated = getStoredTrips().map(t => t.tripCode === payload.tripCode ? payload : t);
          saveTrips(updated);
        } catch (e) {}
      }
    }
	// ---------- Supabase config (Step 2) ----------
const SUPABASE_URL = "https://tzrwwftdlyzplzygroli.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_5AJ6s1Z246T1wV6T0sRe1A_C8aRcTU2";

// create client (UMD export is `supabase`)
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// small helper to patch trip objects for DB (ensures proper types)
function normalizeTripForDB(trip) {
  const copy = { ...trip };
  // convert JS dates to ISO strings where applicable
  if (copy.startDate && typeof copy.startDate === "string") {
    // ok
  }
  // ensure jsonb fields are actual objects
  copy.transactions = copy.transactions || {};
  copy.payments = copy.payments || [];
  copy.vehicleHealth = copy.vehicleHealth || {};
  copy.lastUpdated = new Date().toISOString();
  return copy;
}


    // ---------- Safe fetch + merge (silent on network) ----------
	// ---------- PART 2: Supabase sync, realtime, autosave, sidebar, mobile nav, reports, prediction ----------

/*
  NOTE:
  - This code expects `supabaseClient` (created earlier) and the UI element IDs present in Part 1.
  - Paste this immediately after the marker inside the same <script> that contains Part 1.
*/

/* ---------- Supabase helpers (push / pull / merge) ---------- */

async function pushTripToSupabase(trip) {
  try {
    const normalized = normalizeTripForDB(trip);
    // upsert by tripCode (primary key) - requires a unique constraint on tripCode in your Supabase table
    const { data, error } = await supabaseClient
      .from("trips")
      .upsert(normalized, { onConflict: ["tripCode"] })
      .select()
      .single();

    if (error) {
      console.warn("Supabase upsert error:", error);
      return { ok: false, error };
    }
    return { ok: true, data };
  } catch (err) {
    console.warn("pushTripToSupabase error:", err);
    return { ok: false, error: err };
  }
}

async function pullTripsFromSupabase() {
  try {
    const { data, error } = await supabaseClient
      .from("trips")
      .select("*")
      .order("lastUpdated", { ascending: false });

    if (error) {
      console.warn("Supabase fetch error:", error);
      return [];
    }
    return Array.isArray(data) ? data : [];
  } catch (err) {
    console.warn("pullTripsFromSupabase error:", err);
    return [];
  }
}

/* Merge strategy:
   - Local wins for fields with more recent lastUpdated
   - If remote is newer, use remote
   - Keeps both transactions/payments arrays merged uniquely by id
*/
function mergeTripObjects(local, remote) {
  if (!local) return remote;
  if (!remote) return local;

  const localUpdated = new Date(local.lastUpdated || 0).getTime();
  const remoteUpdated = new Date(remote.lastUpdated || 0).getTime();

  const winner = remoteUpdated > localUpdated ? remote : local;
  const loser = remoteUpdated > localUpdated ? local : remote;

  const merged = { ...winner };

  // Merge transactions: keep unique ids
  merged.transactions = merged.transactions || {};
  loser.transactions = loser.transactions || {};
  Object.keys({ ...merged.transactions, ...loser.transactions }).forEach(cat => {
    const a = merged.transactions[cat] || [];
    const b = loser.transactions[cat] || [];
    const map = new Map();
    a.concat(b).forEach(item => map.set(item.id || uid("x"), item));
    merged.transactions[cat] = Array.from(map.values());
  });

  // Merge payments
  merged.payments = merged.payments || [];
  loser.payments = loser.payments || [];
  const payMap = new Map();
  merged.payments.concat(loser.payments).forEach(p => payMap.set(p.id || uid("p"), p));
  merged.payments = Array.from(payMap.values());

  // Keep computed fields from winner, but recalc derived totals
  updateDerivedCategoryTotals(merged);
  merged.lastUpdated = new Date().toISOString();

  return merged;
}

/* Safe, silent background sync that tries Supabase first then merges */
async function safeSyncAllLocalToSupabase() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.warn("Supabase not configured; skipping safeSyncAllLocalToSupabase.");
    return;
  }

  // Pull remote trips
  const remoteTrips = await pullTripsFromSupabase().catch(() => []);
  const localTrips = getStoredTrips();

  // Build maps
  const remoteMap = new Map(remoteTrips.map(r => [r.tripCode, r]));
  const localMap = new Map(localTrips.map(l => [l.tripCode, l]));

  // Merge keys
  const allKeys = new Set([...remoteMap.keys(), ...localMap.keys()]);

  for (const key of allKeys) {
    const local = localMap.get(key);
    const remote = remoteMap.get(key);

    const merged = mergeTripObjects(local, remote);
    // locally save merged
    const existingLocal = localTrips.findIndex(t => t.tripCode === merged.tripCode);
    if (existingLocal >= 0) localTrips[existingLocal] = merged;
    else localTrips.push(merged);

    // push merged to remote (so both sides converge)
    try {
      const res = await pushTripToSupabase(merged);
      if (!res.ok) {
        console.warn("Failed to push merged trip to supabase:", merged.tripCode);
      }
    } catch (e) {
      console.warn("push error:", e);
    }
  }

  saveTrips(localTrips);
  renderTripsTable();
  renderActiveTrips();
  renderVehicleSummary();
  showToast("Auto-merged local & cloud trips.", "success", 2500);
}

/* push a single trip with optimistic local save */
async function saveTripWithSupabase(trip) {
  // local save already handled by saveTrip; use push to supabase afterwards
  const pushed = await pushTripToSupabase(trip);
  if (pushed.ok && pushed.data) {
    // merge response into local
    const trips = getStoredTrips();
    const idx = trips.findIndex(t => t.tripCode === trip.tripCode);
    if (idx >= 0) {
      const merged = mergeTripObjects(trips[idx], pushed.data);
      trips[idx] = merged;
      saveTrips(trips);
      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();
    }
    return true;
  }
  return false;
}

/* Patch existing saveTrip to attempt supabase push (without breaking local-first behavior)
   We'll wrap the original saveTrip so existing calls continue to work.
*/
const _orig_saveTrip = saveTrip;
saveTrip = async function(payload) {
  // first do local save & existing logic (silent)
  await _orig_saveTrip(payload);

  // if supabase configured, attempt to push in background (silently)
  if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    try {
      await saveTripWithSupabase(payload);
      // show a small positive toast only on explicit user saves (already done by original)
    } catch (e) {
      console.warn("Background supabase push failed:", e);
    }
  }
};

/* Realtime listener: update local store when a remote change occurs */
function setupRealtimeSubscription() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;

  try {
    // subscribe to changes in "trips" table
    supabaseClient
      .channel("public:trips")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "trips" },
        async (payload) => {
          try {
            const rec = payload.new || payload.old;
            if (!rec || !rec.tripCode) return;
            const local = getStoredTrips();
            const idx = local.findIndex(t => t.tripCode === rec.tripCode);
            if (payload.eventType === "DELETE") {
              if (idx >= 0) {
                local.splice(idx, 1);
                saveTrips(local);
                renderTripsTable();
                renderActiveTrips();
                renderVehicleSummary();
                showToast(`Trip ${rec.tripCode} removed from cloud.`, "info", 1800);
              }
              return;
            }
            // On INSERT/UPDATE -> merge
            const merged = mergeTripObjects(local[idx], rec);
            if (idx >= 0) local[idx] = merged; else local.push(merged);
            saveTrips(local);
            renderTripsTable();
            renderActiveTrips();
            renderVehicleSummary();
            // silent small toast (non-intrusive)
            // showToast(`Cloud update: ${rec.tripCode}`, "info", 1400);
          } catch (e) {
            console.warn("Realtime payload handling error", e);
          }
        }
      )
      .subscribe();
  } catch (e) {
    console.warn("Realtime setup failed:", e);
  }
}

/* ---------- Auto-backup scheduler ---------- */

let autoBackupIntervalId = null;

function startAutoBackup(intervalMinutes = 10) {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
  clearAutoBackup();
  autoBackupIntervalId = setInterval(() => {
    safeSyncAllLocalToSupabase();
  }, Math.max(1, intervalMinutes) * 60 * 1000);
  showToast(`Auto-backup every ${intervalMinutes} min enabled.`, "success", 1800);
}

function clearAutoBackup() {
  if (autoBackupIntervalId) {
    clearInterval(autoBackupIntervalId);
    autoBackupIntervalId = null;
  }
}

/* Attach a small hidden control for toggling auto-backup (non-intrusive) */
(function addAutoBackupToggle() {
  const el = document.createElement("div");
  el.style.position = "fixed";
  el.style.left = "12px";
  el.style.bottom = "12px";
  el.style.zIndex = "99998";
  el.style.fontSize = "12px";
  el.innerHTML = `<button id="autoBackupToggle" class="btn-ghost btn-small" title="Toggle auto-backup">Auto-backup: Off</button>`;
  document.body.appendChild(el);
  document.getElementById("autoBackupToggle").addEventListener("click", (e) => {
    if (autoBackupIntervalId) {
      clearAutoBackup();
      e.currentTarget.textContent = "Auto-backup: Off";
      showToast("Auto-backup disabled.", "info");
    } else {
      startAutoBackup(10);
      e.currentTarget.textContent = "Auto-backup: On";
    }
  });
})();

/* ---------- Sidebar / Mobile nav wiring ---------- */
(function setupSidebarToggle() {
  // build toggle button in header
  const btn = document.createElement("button");
  btn.className = "btn-ghost";
  btn.id = "sidebarToggleBtn";
  btn.textContent = "‚ò∞";
  const headerActions = document.querySelector(".header-actions");
  if (headerActions) headerActions.insertBefore(btn, headerActions.firstChild);

  btn.addEventListener("click", () => {
    const sidebar = document.querySelector(".sidebar");
    if (!sidebar) {
      // create simple sidebar when missing (Part1 had hidden sidebar for small screens)
      const s = document.createElement("div");
      s.className = "sidebar expanded";
      s.innerHTML = `<div class="logo">Sasi Transports</div>
        <button class="nav-btn" id="navHomeBtn">üè† Home</button>
        <button class="nav-btn" id="navHistoryBtn">üìú History</button>
        <button class="nav-btn" id="navNewTripBtn">‚ûï New Trip</button>
        <button class="nav-btn" id="navVehiclesBtn">üöö Vehicles</button>`;
      document.querySelector(".page").insertBefore(s, document.querySelector(".page").firstChild);
      wireSidebarButtons();
      return;
    }
    sidebar.classList.toggle("expanded");
  });

  function wireSidebarButtons() {
    const navHome = document.getElementById("navHomeBtn");
    const navHistory = document.getElementById("navHistoryBtn");
    const navNewTrip = document.getElementById("navNewTripBtn");
    if (navHome) navHome.addEventListener("click", showHome);
    if (navHistory) navHistory.addEventListener("click", showHistory);
    if (navNewTrip) navNewTrip.addEventListener("click", showNewTrip);
  }
})();

/* Mobile bottom nav wiring */
(function setupMobileBottomNav() {
  const nav = document.querySelector(".mobile-bottom-nav");
  if (!nav) {
    const el = document.createElement("div");
    el.className = "mobile-bottom-nav";
    el.innerHTML = `
      <button id="mbHome" class="btn-small">Home</button>
      <button id="mbNew" class="btn-small">New</button>
      <button id="mbHistory" class="btn-small">History</button>
    `;
    document.body.appendChild(el);
    document.getElementById("mbHome").addEventListener("click", showHome);
    document.getElementById("mbNew").addEventListener("click", showNewTrip);
    document.getElementById("mbHistory").addEventListener("click", showHistory);
  }
})();

/* ---------- Predictive profit calculator (simple ML-ish heuristic) ----------
   A small helper that suggests an adjusted price to reach target profit margin.
   This is intentionally simple and deterministic (no external ML).
*/
function predictPriceForTargetProfit(trip, targetProfitPercent = 10) {
  // targetProfitPercent: e.g. 10 for 10%
  const estCost = toNumber(trip.estimatedTripCost || trip.estimatedTripCost);
  if (estCost <= 0) return null;
  // desired profit amount:
  const targetProfit = (targetProfitPercent / 100) * estCost;
  const suggestedPrice = estCost + targetProfit;
  // add small buffer for uncertainty (2%)
  return Math.ceil(suggestedPrice * 1.02);
}

/* Add a quick UI control to suggest price when editing a trip in form */
(function injectPredictiveUI() {
  const wrapper = document.createElement("div");
  wrapper.style.marginTop = "8px";
  wrapper.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
    <label class="muted" style="min-width:170px">Suggest price for target profit %</label>
    <input type="number" id="predictTargetPct" value="10" min="0" step="1" style="width:80px;border-radius:8px;padding:6px"/>
    <button id="runPredict" class="btn-outline btn-small">Suggest</button>
    <div id="predictResult" style="margin-left:8px;font-weight:700"></div>
  </div>`;
  const formCardEl = document.getElementById("formCard");
  if (formCardEl) formCardEl.appendChild(wrapper);

  document.getElementById("runPredict").addEventListener("click", () => {
    const pct = toNumber(document.getElementById("predictTargetPct").value) || 10;
    const est = toNumber(estimatedCostInput.value || 0);
    const pseudoTrip = { estimatedTripCost: est };
    const suggestion = predictPriceForTargetProfit(pseudoTrip, pct);
    const resultEl = document.getElementById("predictResult");
    if (!suggestion) resultEl.textContent = "Enter estimated cost first";
    else resultEl.textContent = `Suggest: ‚Çπ${suggestion.toLocaleString("en-IN")}`;
  });
})();

/* ---------- Monthly / Yearly reports (CSV + aggregated summary) ---------- */

function generateFinancialReport({ period = "month", year = null, month = null } = {}) {
  const trips = getStoredTrips();
  let filtered = trips.slice();
  if (period === "month" && year && month) {
    const mm = month.toString().padStart(2, "0");
    filtered = filtered.filter(t => (t.startDate || "").slice(0,7) === `${year}-${mm}`);
  } else if (period === "year" && year) {
    filtered = filtered.filter(t => (t.startDate || "").slice(0,4) === String(year));
  }

  const totalBilled = filtered.reduce((s, t) => s + toNumber(t.totalTransportCost || 0), 0);
  const totalEstCost = filtered.reduce((s, t) => s + toNumber(t.estimatedTripCost || 0), 0);
  const totalProfit = filtered.reduce((s, t) => s + toNumber(t.estimatedProfit || 0), 0);
  const totalPending = filtered.reduce((s, t) => s + toNumber(t.pendingFromClient || 0), 0);

  return {
    trips: filtered,
    totalBilled,
    totalEstCost,
    totalProfit,
    totalPending
  };
}

function downloadReportCSV(reportObj, filename = "financial_report.csv") {
  const headers = ["tripCode","startDate","routeFrom","routeTo","vehicle","totalTransportCost","estimatedTripCost","estimatedProfit","pendingFromClient","status","lastUpdated"];
  const rows = reportObj.trips.map(t => headers.map(h => csvEscape(t[h] ?? "")).join(","));
  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("Report downloaded.", "success");
}

/* Expose a small report UI in history card */
(function addReportsUI() {
  const wrapper = document.createElement("div");
  wrapper.style.marginTop = "8px";
  wrapper.style.display = "flex";
  wrapper.style.gap = "8px";
  wrapper.style.alignItems = "center";
  wrapper.innerHTML = `
    <select id="reportYear"></select>
    <select id="reportMonth"></select>
    <button id="runReport" class="btn-outline btn-small">Run report</button>
    <button id="downloadReport" class="btn-ghost btn-small">Download CSV</button>
    <div id="reportSummary" style="margin-left:10px;color:#cbd5f5;font-weight:600"></div>
  `;
  const tripsListCardEl = document.getElementById("tripsListCard");
  if (tripsListCardEl) tripsListCardEl.querySelector(".card-header").appendChild(wrapper);

  const yearSel = document.getElementById("reportYear");
  const monthSel = document.getElementById("reportMonth");
  const now = new Date();
  for (let y = now.getFullYear(); y >= now.getFullYear() - 4; y--) {
    const opt = document.createElement("option"); opt.value = y; opt.textContent = y; yearSel.appendChild(opt);
  }
  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement("option"); opt.value = m; opt.textContent = m; monthSel.appendChild(opt);
  }
  yearSel.value = now.getFullYear();
  monthSel.value = now.getMonth() + 1;

  let lastReport = null;
  document.getElementById("runReport").addEventListener("click", () => {
    const y = Number(yearSel.value);
    const m = Number(monthSel.value);
    lastReport = generateFinancialReport({ period: "month", year: y, month: m });
    document.getElementById("reportSummary").textContent = `Trips: ${lastReport.trips.length} ‚Ä¢ Billed: ${formatCurrency(lastReport.totalBilled)} ‚Ä¢ Profit: ${formatCurrency(lastReport.totalProfit)}`;
    showToast("Report generated.", "info");
  });

  document.getElementById("downloadReport").addEventListener("click", () => {
    if (!lastReport) {
      showToast("Run report first.", "error");
      return;
    }
    const y = yearSel.value;
    const m = monthSel.value.toString().padStart(2,"0");
    downloadReportCSV(lastReport, `report_${y}-${m}.csv`);
  });
})();

/* ---------- Small UX improvements ---------- */

// Warn if leaving with unsaved changes (already handled by guardLeaveForm on actions) but also bind window unload
window.addEventListener("beforeunload", (e) => {
  if (formDirty) {
    e.preventDefault();
    e.returnValue = "";
  }
});

// quick "repair" button to re-run safe merge (useful for user)
(function addManualMergeButton() {
  const btn = document.createElement("button");
  btn.className = "btn-ghost btn-small";
  btn.style.position = "fixed";
  btn.style.right = "12px";
  btn.style.bottom = "12px";
  btn.style.zIndex = "99998";
  btn.textContent = "Merge cloud";
  document.body.appendChild(btn);
  btn.addEventListener("click", async () => {
    showToast("Merging local & cloud...", "info", 1400);
    await safeSyncAllLocalToSupabase();
  });
})();

/* ---------- Wire initial auto-sync + realtime ---------- */
(async function startupSync() {
  // Attempt safe merge once on startup (silent)
  if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    try {
      await safeSyncAllLocalToSupabase();
      setupRealtimeSubscription();
    } catch (e) {
      console.warn("startupSync failed", e);
    }
  } else {
    // fallback: call existing server fetch (Part1 had API_BASE fetch)
    try { await fetchTripsFromServer(); } catch(e){}
  }
})();

/* ---------- Small placeholder for advanced features: GPS, Toll, AI-analysis ----------
   These are intentionally left as stubs ‚Äî they can be implemented after you enable APIs/keys.
*/
const AdvancedFeatures = {
  async integrateGPS(vehicleId) {
    // placeholder: would call your GPS provider; returns { lat, lng, ts }
    return null;
  },
  async fetchTollCost(routeFrom, routeTo) {
    // placeholder: call toll API if available
    return 0;
  },
  async analyzeExpensesWithAI(trip) {
    // placeholder: could send aggregated expense data to an AI service
    return { suggestions: [] };
  }
};

/* ---------- END OF PART 2 ---------- */

  async function fetchTripsFromServer() {
      if (!API_BASE) {
        return;
      }
      try {
        const res = await fetch(API_BASE + "/trips");
        if (!res.ok) {
          console.warn("fetchTripsFromServer: status", res.status);
          return;
        }
        const serverTrips = await res.json();
        if (!Array.isArray(serverTrips)) {
          console.warn("Unexpected server response for /trips", serverTrips);
          return;
        }
        const local = getStoredTrips();
        const map = new Map(local.map(t => [t.tripCode, t]));
        serverTrips.forEach(st => { if (!st.tripCode) return; st.syncStatus = "ok"; map.set(st.tripCode, st); });
        const merged = Array.from(map.values());
        saveTrips(merged);
        showToast("Fetched trips from server.", "success");
        // UI render functions defined later
        renderTripsTable?.();
        renderActiveTrips?.();
        renderVehicleSummary?.();
      } catch (err) {
        console.warn("Silent fetch error:", err);
      }
    }

    // ---------- CSV export / import (includes transactions & payments & vehicle) ----------
    function csvEscape(v) {
      if (v === null || v === undefined) return "";
      const s = String(v);
      if (s.includes(",") || s.includes('"') || s.includes("\n")) {
        return '"' + s.replaceAll('"', '""') + '"';
      }
      return s;
    }

    function exportCsv() {
      const trips = getStoredTrips();
      if (!trips.length) { showToast("No trips to export.", "info"); return; }
      const headers = [
        "tripCode",
        "startDate",
        "routeFrom",
        "routeTo",
        "vehicle",
        "totalTransportCost",
        "estimatedTripCost",
        "estimatedProfit",
        "advancePaid",
        "advancePaidDate",
        "pendingFromClient",
        "amountUsed",
        "amountLeft",
        "status",
        "lastUpdated",
        "transactions_json",
        "payments_json"
      ];
      const rows = trips.map(t => {
        const txnsJson = JSON.stringify(t.transactions || {});
        const paysJson = JSON.stringify(t.payments || []);
        const amountUsed = calculateAmountUsed(t);
        const amountLeft = calculateAmountLeft(t);
        return headers.map(h =>
          csvEscape(
            h === "transactions_json"
              ? txnsJson
              : h === "payments_json"
              ? paysJson
              : h === "amountUsed"
              ? amountUsed
              : h === "amountLeft"
              ? amountLeft
              : t[h]
          )
        ).join(",");
      });
      const csv = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `trips_export_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("Exported CSV.", "success");
    }

    function parseCsvLine(line) {
      const res = [];
      let cur = "";
      let inQuotes = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i+1] === '"') { cur += '"'; i++; } else inQuotes = false;
          } else cur += ch;
        } else {
          if (ch === ',') { res.push(cur); cur = ""; } else if (ch === '"') { inQuotes = true; } else cur += ch;
        }
      }
      res.push(cur);
      return res;
    }

    function importCsv(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (!lines.length) { showToast("CSV empty.", "error"); return; }
      const header = parseCsvLine(lines[0]);
      const rows = lines.slice(1).map(l => parseCsvLine(l));
      const items = rows.map(r => {
        const obj = {};
        for (let i=0;i<header.length;i++){ const key = header[i]; obj[key] = r[i] ?? ""; }
        obj.totalTransportCost = toNumber(obj.totalTransportCost);
        obj.estimatedTripCost = toNumber(obj.estimatedTripCost);
        obj.estimatedProfit = toNumber(obj.estimatedProfit);
        obj.advancePaid = toNumber(obj.advancePaid);
        obj.pendingFromClient = toNumber(obj.pendingFromClient);
        obj.lastUpdated = obj.lastUpdated || new Date().toISOString();
        try { obj.transactions = obj.transactions_json ? JSON.parse(obj.transactions_json) : {}; } catch { obj.transactions = {}; }
        try { obj.payments = obj.payments_json ? JSON.parse(obj.payments_json) : []; } catch { obj.payments = []; }
        if (!obj.tripCode) obj.tripCode = generateTripCode(obj.startDate || todayISO());
        return obj;
      });
      const local = getStoredTrips();
      const map = new Map(local.map(t => [t.tripCode, t]));
      items.forEach(it => map.set(it.tripCode, it));
      const merged = Array.from(map.values());
      saveTrips(merged);
      renderTripsTable?.();
      renderActiveTrips?.();
      renderVehicleSummary?.();
      showToast("Imported CSV and merged trips.", "success");
    }

    // ---------- Trip code ---------- (unchanged)
    const usedTripCodes = new Set();
    function generateTripCode(startDate) {
      if (!startDate) startDate = new Date().toISOString().slice(0,10);
      const y = startDate.slice(0, 4);
      const m = startDate.slice(5, 7);
      const d = startDate.slice(8, 10);
      let code;
      do {
        const random = Math.floor(10000 + Math.random() * 90000);
        code = `TR-${y}${m}${d}-${random}`;
      } while (usedTripCodes.has(code));
      usedTripCodes.add(code);
      return code;
    }

     // ---------- DOM refs + state ----------
    let currentUpdateTripCode = null;
    let activeVehicleFilterValue = "";   // for Home active trips
    let formDirty = false;               // unsaved changes

    const modeScreen = document.getElementById("modeScreen");
    const modeNewTripBtn = document.getElementById("modeNewTripBtn");
    const modeViewHistoryBtn = document.getElementById("modeViewHistoryBtn");
    const headerHomeBtn = document.getElementById("headerHomeBtn");
    const headerViewHistoryBtn = document.getElementById("headerViewHistoryBtn");

    const mainLayout = document.getElementById("mainLayout");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const nextStepBtn = document.getElementById("nextStepBtn");
    const backStepBtn = document.getElementById("backStepBtn");
    const resetBtn = document.getElementById("resetBtn");
    const stepPill = document.getElementById("stepPill");
    const stepIndicator = document.getElementById("stepIndicator");
    const advancePaidInput = document.getElementById("advancePaid");
    const advanceDateGroup = document.getElementById("advanceDateGroup");
    const tripCodeInput = document.getElementById("tripCode");
    const routeFromInput = document.getElementById("routeFrom");
    const routeToInput = document.getElementById("routeTo");
    const startDateInput = document.getElementById("startDate");
    const vehicleInput = document.getElementById("vehicle");
    const totalCostInput = document.getElementById("totalCost");
    const estimatedCostInput = document.getElementById("estimatedCost");
    const advancePaidDateInput = document.getElementById("advancePaidDate");

    const formCard = document.getElementById("formCard");
    const summaryCard = document.getElementById("summaryCard");
    const summaryContent = document.getElementById("summaryContent");
    const savedMessage = document.getElementById("savedMessage");
    const viewSavedRecordBtn = document.getElementById("viewSavedRecordBtn");
    const newTripBtn = document.getElementById("newTripBtn");
    const editTripBtn = document.getElementById("editTripBtn");
    const summarySaveBtn = document.getElementById("summarySaveBtn");
    const summaryStatusEl = document.getElementById("summaryStatus");
    const summaryTitleEl = document.getElementById("summaryTitle");

    const tripsListCard = document.getElementById("tripsListCard");
    const historyNewTripBtn = document.getElementById("historyNewTripBtn");
    const tripsTableBody = document.getElementById("tripsTableBody");
    const historySearch = document.getElementById("historySearch");
    const historyFromDate = document.getElementById("historyFromDate");
    const historyToDate = document.getElementById("historyToDate");
    const vehicleFilter = document.getElementById("vehicleFilter");

    const summaryTripsCount = document.getElementById("summaryTripsCount");
    const summaryTotalBilled = document.getElementById("summaryTotalBilled");
    const summaryTotalProfit = document.getElementById("summaryTotalProfit");
    const summaryTotalPending = document.getElementById("summaryTotalPending");

    const activeTripsBody = document.getElementById("activeTripsBody");
    const activeVehicleFilters = document.getElementById("activeVehicleFilters");
    const vehicleSummaryBody = document.getElementById("vehicleSummaryBody");

    const updateCard = document.getElementById("updateCard");
    const updateTripCodeTag = document.getElementById("updateTripCodeTag");
    const updateRouteDisplay = document.getElementById("updateRouteDisplay");
    const updateStartDateDisplay = document.getElementById("updateStartDateDisplay");
    const updatePendingDisplay = document.getElementById("updatePendingDisplay");
    const txnsGrid = document.getElementById("txnsGrid");
    const updateBackBtn = document.getElementById("updateBackBtn");
    const updateDoneBtn = document.getElementById("updateDoneBtn");

    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const importCsvInput = document.getElementById("importCsvInput");
    const tripForm = document.getElementById("tripForm");

    // ---------- Unsaved changes helper ----------
    function markFormDirty() {
      // Only mark dirty when main form is visible
      if (!mainLayout.classList.contains("hidden")) {
        formDirty = true;
      }
    }

    function clearFormDirty() {
      formDirty = false;
    }

    function guardLeaveForm() {
      if (!mainLayout.classList.contains("hidden")) {
        if (formDirty) {
          const ok = confirm("You have unsaved changes in this trip. Leave without saving?");
          if (!ok) return false;
          formDirty = false;
        }
      }
      return true;
    }

    // ---------- Summary reset ----------
    function resetSummary() {
      document.getElementById("tripCodeDisplay").textContent = "‚Äî";
      document.getElementById("vehicleDisplay").textContent = "‚Äî";
      document.getElementById("routeDisplay").textContent = "‚Äî";
      document.getElementById("startDateDisplay").textContent = "‚Äî";
      document.getElementById("totalCostDisplay").textContent = "‚Çπ0";
      document.getElementById("estimatedCostDisplay").textContent = "‚Çπ0";
      document.getElementById("profitDisplay").textContent = "‚Çπ0";
      document.getElementById("advanceDisplay").textContent = "‚Çπ0";
      document.getElementById("pendingDisplay").textContent = "‚Çπ0";
      document.getElementById("advanceDateDisplay").textContent = "‚Äî";
      summaryStatusEl.textContent = "Preview";
      summaryTitleEl.textContent = "Fill the form to see totals.";
      document.getElementById("profitBadgeText").textContent = "No profit data yet";
      document.getElementById("pendingBadgeText").textContent = "No pending amount yet";
      document.getElementById("profitDisplay").classList.remove("positive", "negative");

      formCard.classList.remove("hidden");
      summaryCard.classList.remove("summary-full");
      summaryCard.classList.add("summary-small");
      newTripBtn.classList.add("hidden");

      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
    }

    // ---------- Vehicle summary ----------
    function renderVehicleSummary() {
      const trips = getStoredTrips();
      vehicleSummaryBody.innerHTML = "";

      VEHICLES.forEach(vehicle => {
        const vt = trips.filter(t => (t.vehicle || "") === vehicle);
        const tripCount = vt.length;
        const activeCount = vt.filter(t => (t.status || "active") !== "closed").length;
        const totalBilled = vt.reduce((s, t) => s + toNumber(t.totalTransportCost || 0), 0);
        const totalProfit = vt.reduce((s, t) => s + toNumber(t.estimatedProfit || 0), 0);

        const card = document.createElement("div");
        card.className = "vehicle-card";

        const header = document.createElement("div");
        header.className = "vehicle-card-header";
        const title = document.createElement("div");
        title.textContent = vehicle;
        const tripsTag = document.createElement("div");
        tripsTag.textContent = `${tripCount} trip${tripCount === 1 ? "" : "s"}`;
        tripsTag.style.fontSize = "0.75rem";
        tripsTag.style.color = "#cbd5f5";
        header.appendChild(title);
        header.appendChild(tripsTag);

        const meta = document.createElement("div");
        meta.className = "vehicle-card-meta";

        const activePill = document.createElement("span");
        activePill.className = "vehicle-pill";
        activePill.textContent = `Active: ${activeCount}`;

        const billedPill = document.createElement("span");
        billedPill.className = "vehicle-pill";
        billedPill.textContent = `Billed: ${formatCurrency(totalBilled)}`;

        const profitPill = document.createElement("span");
        profitPill.className = "vehicle-pill";
        profitPill.textContent = `Est. profit: ${formatCurrency(totalProfit)}`;

        meta.appendChild(activePill);
        meta.appendChild(billedPill);
        meta.appendChild(profitPill);

        card.appendChild(header);
        card.appendChild(meta);

        vehicleSummaryBody.appendChild(card);
      });
    }

    // ---------- Render active trips ----------
    function renderActiveTrips() {
      const trips = getStoredTrips().filter(
        t => (t.status || "active") !== "closed"
      );

      activeTripsBody.innerHTML = "";

      let filtered = trips;
      if (activeVehicleFilterValue) {
        filtered = trips.filter(t => (t.vehicle || "") === activeVehicleFilterValue);
      }

      if (!filtered.length) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "No active trips.";
        activeTripsBody.appendChild(p);
        return;
      }

      filtered.forEach(trip => {
        if (trip.tripCode) usedTripCodes.add(trip.tripCode);

        const item = document.createElement("div");
        item.className = "active-item";

        const main = document.createElement("div");
        main.className = "active-item-main";

        const dot = document.createElement("span");
        const isLoss = (trip.estimatedProfit || 0) < 0;
        dot.className = "status-dot " + (isLoss ? "loss" : "active");

        const textWrap = document.createElement("div");
        textWrap.className = "active-item-text";

        const routeText = document.createElement("div");
        routeText.className = "active-item-route";
        routeText.textContent =
          (trip.tripCode ? trip.tripCode + " ‚Ä¢ " : "") +
          (trip.routeFrom || "") +
          " ‚Üí " +
          (trip.routeTo || "");

        const meta = document.createElement("div");
        meta.className = "active-item-meta";
        let metaText = trip.startDate
          ? "Start: " + trip.startDate
          : "No start date";
        if (trip.vehicle) {
          metaText += " ‚Ä¢ Vehicle: " + trip.vehicle;
        }
        meta.textContent = metaText;

        textWrap.appendChild(routeText);
        textWrap.appendChild(meta);

        main.appendChild(dot);
        main.appendChild(textWrap);

        const btnWrap = document.createElement("div");
        btnWrap.style.display = "flex";
        btnWrap.style.gap = "6px";

        const updateBtn = document.createElement("button");
        updateBtn.className = "btn-ghost btn-small";
        updateBtn.textContent = "Update";
        updateBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          updateTrip(trip.tripCode);
        });

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn-ghost btn-small";
        closeBtn.textContent = "Close trip";
        closeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeTrip(trip.tripCode);
        });

        btnWrap.appendChild(updateBtn);
        btnWrap.appendChild(closeBtn);

        item.appendChild(main);
        item.appendChild(btnWrap);

        activeTripsBody.appendChild(item);
      });
    }

    // ---------- History filters helper ----------
    function tripMatchesFilters(trip, q, vFilter, fromDate, toDate) {
      const code = (trip.tripCode || "").toLowerCase();
      const from = (trip.routeFrom || "").toLowerCase();
      const to = (trip.routeTo || "").toLowerCase();

      if (q && !(code.includes(q) || from.includes(q) || to.includes(q))) {
        return false;
      }

      if (vFilter && (trip.vehicle || "") !== vFilter) {
        return false;
      }

      const sd = (trip.startDate || "").slice(0,10); // yyyy-mm-dd
      if (fromDate && sd && sd < fromDate) return false;
      if (toDate && sd && sd > toDate) return false;

      return true;
    }

    // ---------- Render trips table + summary bar ----------
    function renderTripsTable() {
      const q = (historySearch.value || "").trim().toLowerCase();
      const vFilter = (vehicleFilter && vehicleFilter.value) || "";
      const fromDate = historyFromDate.value || "";
      const toDate = historyToDate.value || "";

      const trips = getStoredTrips();
      tripsTableBody.innerHTML = "";

      let filtered = trips.filter(t => tripMatchesFilters(t, q, vFilter, fromDate, toDate));

      // Summary bar calculations
      const tripsCount = filtered.length;
      const totalBilled = filtered.reduce((s, t) => s + toNumber(t.totalTransportCost || 0), 0);
      const totalProfit = filtered.reduce((s, t) => s + toNumber(t.estimatedProfit || 0), 0);
      const totalPending = filtered.reduce((s, t) => s + toNumber(t.pendingFromClient || 0), 0);

      summaryTripsCount.textContent = `Trips: ${tripsCount}`;
      summaryTotalBilled.textContent = `Total billed: ${formatCurrency(totalBilled)}`;
      summaryTotalProfit.textContent = `Est. profit: ${formatCurrency(totalProfit)}`;
      summaryTotalPending.textContent = `Pending: ${formatCurrency(totalPending)}`;

      if (!filtered.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 12;
        cell.textContent = q || vFilter || fromDate || toDate
          ? "No trips match your filters."
          : "No trips saved yet.";
        cell.style.fontSize = "0.9rem";
        cell.style.color = "#9ca3af";
        row.appendChild(cell);
        tripsTableBody.appendChild(row);
        return;
      }

      filtered.forEach(trip => {
        if (trip.tripCode) usedTripCodes.add(trip.tripCode);

        const row = document.createElement("tr");
        row.dataset.tripCode = trip.tripCode;
        row.classList.add("trip-row");

        const status = trip.status || "active";
        const isLoss = (trip.estimatedProfit || 0) < 0;
        const isProfit = (trip.estimatedProfit || 0) > 0;

        if (status === "closed") {
          row.classList.add("closed");
        } else if (isLoss) {
          row.classList.add("loss");
        } else if (isProfit) {
          row.classList.add("profit");
        }

        // Status cell
        const statusTd = document.createElement("td");
        const dot = document.createElement("span");
        let statusClass;
        if (status === "closed") statusClass = "closed";
        else if (isLoss) statusClass = "loss";
        else statusClass = "active";
        dot.className = "status-dot " + statusClass;

        const chip = document.createElement("span");
        chip.className = "status-chip " + statusClass;
        if (status === "closed") chip.textContent = "Closed";
        else if (isLoss) chip.textContent = "Loss trip";
        else chip.textContent = "Active";

        statusTd.appendChild(dot);
        statusTd.appendChild(chip);
        row.appendChild(statusTd);

        const routeText = `${(trip.routeFrom||"")} ‚Üí ${(trip.routeTo||"")}`;
        const vehicle = trip.vehicle || "";

        // compute amount used & left
        const used = calculateAmountUsed(trip);
        const left = calculateAmountLeft(trip);

        const cells = [
          trip.tripCode,
          routeText,
          vehicle,
          trip.startDate || "",
          formatCurrency(trip.totalTransportCost || 0),
          formatCurrency(trip.estimatedTripCost || 0),
          formatCurrency(used),         // Amount Used
          formatCurrency(left),         // Amount Left
          formatCurrency(trip.estimatedProfit || 0),
          formatCurrency(trip.pendingFromClient || 0)
        ];

        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          row.appendChild(td);
        });

        // Actions column
        const actionsTd = document.createElement("td");
        if (status === "closed") {
          actionsTd.textContent = "Closed";
          actionsTd.style.fontSize = "0.8rem";
          actionsTd.style.color = "#9ca3af";
        } else {
          const updateBtn = document.createElement("button");
          updateBtn.className = "btn-ghost btn-small";
          updateBtn.textContent = "Update";
          updateBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            updateTrip(trip.tripCode);
          });

          const closeBtn = document.createElement("button");
          closeBtn.className = "btn-ghost btn-small";
          closeBtn.textContent = "Close trip";
          closeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            closeTrip(trip.tripCode);
          });

          actionsTd.appendChild(updateBtn);
          actionsTd.appendChild(closeBtn);
        }
        row.appendChild(actionsTd);

        // Click row to load into form for editing
        row.addEventListener("click", () => {
          loadTripIntoForm(trip.tripCode);
        });

        tripsTableBody.appendChild(row);
      });
    }

    // ---------- Close trip ----------
    async function closeTrip(tripCode) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      trips[idx].status = "closed";
      trips[idx].syncStatus = "pending";
      saveTrips(trips);
      await saveTrip(trips[idx]);
      renderActiveTrips();
      renderTripsTable();
      renderVehicleSummary();
      showToast("Trip closed.", "info");
    }

    // ---------- Navigation / UI helpers ----------
    function showHome() {
      if (!guardLeaveForm()) return;
      modeScreen.classList.remove("hidden");
      mainLayout.classList.add("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.add("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showHistory() {
      if (!guardLeaveForm()) return;
      modeScreen.classList.add("hidden");
      mainLayout.classList.add("hidden");
      updateCard.classList.add("hidden");
      tripsListCard.classList.remove("hidden");
      headerViewHistoryBtn.classList.add("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showNewTrip() {
      if (!guardLeaveForm()) return;
      modeScreen.classList.add("hidden");
      mainLayout.classList.remove("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.remove("hidden");
      prefillNewTripForm();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openUpdatePage(tripCode) {
      if (!guardLeaveForm()) return;
      const trips = getStoredTrips();
      const trip = trips.find(t => t.tripCode === tripCode);
      if (!trip) {
        showToast("Trip not found.", "error");
        return;
      }
      currentUpdateTripCode = tripCode;

      updateTripCodeTag.textContent = trip.tripCode || "TRIP";
      const routeText = (trip.routeFrom || "") + " ‚Üí " + (trip.routeTo || "");
      updateRouteDisplay.textContent = routeText || "‚Äî";
      updateStartDateDisplay.textContent = trip.startDate || "‚Äî";
      updatePendingDisplay.textContent = formatCurrency(trip.pendingFromClient || 0);

      renderTxnsForTrip(trip);

      modeScreen.classList.add("hidden");
      mainLayout.classList.add("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.remove("hidden");
      headerViewHistoryBtn.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function updateTrip(tripCode) {
      openUpdatePage(tripCode);
    }

    // ---------- Load trip into form for editing ----------
    function loadTripIntoForm(tripCode) {
      const trips = getStoredTrips();
      const trip = trips.find(t => t.tripCode === tripCode);
      if (!trip) {
        showToast("Trip not found.", "error");
        return;
      }
      modeScreen.classList.add("hidden");
      mainLayout.classList.remove("hidden");
      tripsListCard.classList.add("hidden");
      updateCard.classList.add("hidden");
      headerViewHistoryBtn.classList.remove("hidden");

      routeFromInput.value = trip.routeFrom || "";
      routeToInput.value = trip.routeTo || "";
      startDateInput.value = trip.startDate || todayISO();
      vehicleInput.value = trip.vehicle || "";
      tripCodeInput.value = trip.tripCode || "";
      totalCostInput.value = trip.totalTransportCost || "";
      estimatedCostInput.value = trip.estimatedTripCost || "";
      document.getElementById("advancePaid").value = trip.advancePaid || "";
      advancePaidDateInput.value = trip.advancePaidDate || "";

      // move to step2
      step1.classList.remove("active");
      step2.classList.add("active");
      stepPill.textContent = "Step 2 of 2";
      stepIndicator.textContent = "Cost details";

      // Update summary preview
      const routeText = (trip.routeFrom || "") + " ‚Üí " + (trip.routeTo || "");
      document.getElementById("tripCodeDisplay").textContent = trip.tripCode || "‚Äî";
      document.getElementById("vehicleDisplay").textContent = trip.vehicle || "‚Äî";
      document.getElementById("routeDisplay").textContent = routeText || "‚Äî";
      document.getElementById("startDateDisplay").textContent = trip.startDate || "‚Äî";
      document.getElementById("totalCostDisplay").textContent = formatCurrency(trip.totalTransportCost || 0);
      document.getElementById("estimatedCostDisplay").textContent = formatCurrency(trip.estimatedTripCost || 0);
      document.getElementById("profitDisplay").textContent = formatCurrency(trip.estimatedProfit || 0);
      document.getElementById("advanceDisplay").textContent = formatCurrency(trip.advancePaid || 0);
      document.getElementById("pendingDisplay").textContent = formatCurrency(trip.pendingFromClient || 0);
      document.getElementById("advanceDateDisplay").textContent =
        trip.advancePaidDate ? trip.advancePaidDate : "‚Äî";

      summaryStatusEl.textContent = "Saved";
      summaryTitleEl.textContent =
        (trip.tripCode ? trip.tripCode + " ‚Ä¢ " : "") +
        routeText +
        (trip.startDate ? " ‚Ä¢ " + trip.startDate : "");

      clearFormDirty();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ---------- Render txn UI (includes payments) ----------
    function renderTxnsForTrip(trip) {
      ensureTripTransactions(trip);
      txnsGrid.innerHTML = "";

      CATEGORIES.forEach(cat => {
        const block = document.createElement("div");
        block.className = "category-block";

        const head = document.createElement("div");
        head.className = "category-head";
        const label = document.createElement("div");
        label.innerHTML = `<strong>${cat.label}</strong>`;
        const total = document.createElement("div");
        total.className = "category-total";
        total.textContent = formatCurrency(sumCategory(trip, cat.key));
        head.appendChild(label);
        head.appendChild(total);

        const inputs = document.createElement("div");
        inputs.className = "small-inputs";
        const amt = document.createElement("input");
        amt.type = "number";
        amt.min = "0";
        amt.step = "0.01";
        amt.placeholder = "Amount";
        amt.id = `txn_${cat.key}_amt`;

        const dt = document.createElement("input");
        dt.type = "date";
        dt.id = `txn_${cat.key}_date`;
        dt.value = todayISO();

        const addBtn = document.createElement("button");
        addBtn.className = "btn-primary btn-small";
        addBtn.textContent = "Add";
        addBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const a = toNumber(amt.value);
          const d = dt.value || todayISO();
          if (a <= 0) {
            showToast("Enter an amount greater than 0 to add.", "error");
            return;
          }
          addTransactionToTrip(currentUpdateTripCode, cat.key, { amount: a, date: d });
          amt.value = "";
          dt.value = todayISO();
        });

        inputs.appendChild(amt);
        inputs.appendChild(dt);
        inputs.appendChild(addBtn);

        const list = document.createElement("div");
        list.className = "txn-list";
        list.id = `txn_list_${cat.key}`;

        const entries = trip.transactions && trip.transactions[cat.key] ? trip.transactions[cat.key] : [];
        if (!entries.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "No entries yet.";
          list.appendChild(p);
        } else {
          entries.slice().reverse().forEach(entry => {
            const row = buildTxnRow(trip.tripCode, cat.key, entry);
            list.appendChild(row);
          });
        }

        block.appendChild(head);
        block.appendChild(inputs);
        block.appendChild(list);
        txnsGrid.appendChild(block);
      });

      // payments block
      const paymentsBlock = document.createElement("div");
      paymentsBlock.className = "category-block";
      paymentsBlock.innerHTML = `<div class="category-head"><div><strong>Payments received</strong></div><div class="category-total">${formatCurrency(calculatePaymentsSum(trip))}</div></div>`;
      const payInputs = document.createElement("div");
      payInputs.className = "small-inputs";
      const payAmt = document.createElement("input"); payAmt.type="number"; payAmt.placeholder="Amount"; payAmt.id="pay_amt";
      const payDate = document.createElement("input"); payDate.type="date"; payDate.value = todayISO(); payDate.id="pay_date";
      const payAdd = document.createElement("button"); payAdd.className="btn-primary btn-small"; payAdd.textContent="Add";
      payAdd.addEventListener("click",(e)=>{
        e.preventDefault(); const a = toNumber(payAmt.value); const d = payDate.value || todayISO();
        if (a <= 0) { showToast("Enter an amount greater than 0 to add payment.", "error"); return; }
        addPaymentToTrip(currentUpdateTripCode, { amount: a, date: d });
        payAmt.value = ""; payDate.value = todayISO();
      });
      payInputs.appendChild(payAmt); payInputs.appendChild(payDate); payInputs.appendChild(payAdd);
      paymentsBlock.appendChild(payInputs);

      const payList = document.createElement("div"); payList.className="txn-list";
      const payments = trip.payments && trip.payments.length ? trip.payments.slice().reverse() : [];
      if (!payments.length) { const p = document.createElement("div"); p.className="muted"; p.textContent="No payments yet."; payList.appendChild(p); }
      else {
        payments.forEach(entry => {
          const r = document.createElement("div"); r.className="txn-row";
          r.innerHTML = `<div style="font-weight:600">${formatCurrency(entry.amount)}</div><div class="txn-meta">${entry.date || "‚Äî"}</div>`;
          payList.appendChild(r);
        });
      }
      paymentsBlock.appendChild(payList);
      txnsGrid.appendChild(paymentsBlock);
    }

    function buildTxnRow(tripCode, catKey, entry) {
      const row = document.createElement("div");
      row.className = "txn-row";
      row.dataset.txnId = entry.id || "";

      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:600">${formatCurrency(entry.amount)}</div><div class="txn-meta">${entry.date || "‚Äî"}</div>`;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";

      const delBtn = document.createElement("button");
      delBtn.className = "btn-ghost btn-small";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await removeTransactionFromTrip(tripCode, catKey, entry.id);
      });

      right.appendChild(delBtn);
      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    async function addTransactionToTrip(tripCode, catKey, { amount, date }) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      const entry = { id: uid("txn_"), amount: Number(amount), date: date || todayISO() };
      trip.transactions[catKey].push(entry);
      updateDerivedCategoryTotals(trip);
      trip.lastUpdated = new Date().toISOString();
      await saveTrip(trip);
      renderTxnsForTrip(trip);
      updatePendingDisplay.textContent = formatCurrency(trip.pendingFromClient || trip.pending || 0);
      showToast(`${formatCurrency(amount)} added to ${catKey}.`, "success");
    }

    async function removeTransactionFromTrip(tripCode, catKey, txnId) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) {
        showToast("Trip not found.", "error");
        return;
      }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      const beforeLen = trip.transactions[catKey].length;
      trip.transactions[catKey] = trip.transactions[catKey].filter(x => x.id !== txnId);
      if (trip.transactions[catKey].length === beforeLen) {
        showToast("Transaction not found.", "error");
        return;
      }
      updateDerivedCategoryTotals(trip);
      trip.lastUpdated = new Date().toISOString();
      await saveTrip(trip);
      renderTxnsForTrip(trip);
      showToast("Transaction removed.", "info");
    }

    async function addPaymentToTrip(tripCode, { amount, date }) {
      const trips = getStoredTrips();
      const idx = trips.findIndex(t => t.tripCode === tripCode);
      if (idx === -1) { showToast("Trip not found.", "error"); return; }
      const trip = trips[idx];
      ensureTripTransactions(trip);
      trip.payments.push({ id: uid("pay_"), amount: Number(amount), date: date || todayISO() });
      trip.lastUpdated = new Date().toISOString();
      trip.pendingFromClient = (toNumber(trip.totalTransportCost || 0)) - (toNumber(trip.advancePaid || 0) + calculatePaymentsSum(trip));
      await saveTrip(trip);
      renderTxnsForTrip(trip);
      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();
      showToast(`${formatCurrency(amount)} recorded as payment.`, "success");
    }

    // ---------- Prefill new trip form (date today + last route) ----------
    function prefillNewTripForm() {
      tripForm.reset();
      tripCodeInput.value = "";
      step2.classList.remove("active");
      step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2";
      stepIndicator.textContent = "Route details";
      advanceDateGroup.style.display = "none";
      resetSummary();

      // default today
      startDateInput.value = todayISO();

      // remember last route & vehicle
      const lastFrom = localStorage.getItem("lastRouteFrom") || "";
      const lastTo = localStorage.getItem("lastRouteTo") || "";
      const lastVehicle = localStorage.getItem("lastVehicle") || "";

      if (lastFrom) routeFromInput.value = lastFrom;
      if (lastTo) routeToInput.value = lastTo;
      if (lastVehicle) vehicleInput.value = lastVehicle;

      clearFormDirty();
    }

    // ---------- Hook CSV buttons ----------
    exportCsvBtn.addEventListener("click", exportCsv);
    importCsvInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        importCsv(text);
      } catch (err) {
        console.error(err);
        showToast("Failed to read CSV file.", "error");
      } finally {
        importCsvInput.value = "";
      }
    });

    // ---------- Init ----------
    (async function init() {
      await fetchTripsFromServer(); // silent on failure
      const existing = getStoredTrips();
      existing.forEach(t => { if (t.tripCode) usedTripCodes.add(t.tripCode); });

      // default history date range: this month
      const today = todayISO();
      historyToDate.value = today;
      const d = new Date();
      d.setDate(1);
      historyFromDate.value = d.toISOString().slice(0,10);

      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();
    })();

    // ---------- Misc UI handlers ----------
    updateBackBtn.addEventListener("click", () => showHome());
    updateDoneBtn.addEventListener("click", () => {
      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();
      showHome();
      showToast("Done updating transactions.", "success");
    });

    modeNewTripBtn.addEventListener("click", showNewTrip);
    modeViewHistoryBtn.addEventListener("click", showHistory);

    headerHomeBtn.addEventListener("click", showHome);
    headerViewHistoryBtn.addEventListener("click", showHistory);

    historyNewTripBtn.addEventListener("click", showNewTrip);

    historySearch.addEventListener("input", renderTripsTable);
    if (vehicleFilter) {
      vehicleFilter.addEventListener("change", renderTripsTable);
    }
    historyFromDate.addEventListener("change", renderTripsTable);
    historyToDate.addEventListener("change", renderTripsTable);

    // Active vehicle filter pills
    if (activeVehicleFilters) {
      activeVehicleFilters.addEventListener("click", (e) => {
        const btn = e.target.closest(".filter-pill");
        if (!btn) return;
        const val = btn.getAttribute("data-vehicle") || "";
        activeVehicleFilterValue = val;
        Array.from(activeVehicleFilters.querySelectorAll(".filter-pill")).forEach(b => {
          b.classList.toggle("active", b === btn);
        });
        renderActiveTrips();
      });
    }

    // Track form changes for unsaved warning
    tripForm.addEventListener("input", () => {
      markFormDirty();
    });

    // NEXT (Step 1 -> Step 2)
    nextStepBtn.addEventListener("click", () => {
      const routeFrom = routeFromInput.value.trim();
      const routeTo = routeToInput.value.trim();
      const startDate = startDateInput.value;
      const vehicle = vehicleInput.value;

      if (!routeFrom || !routeTo || !startDate || !vehicle) {
        showToast("Please fill From, To, Start date and Vehicle to continue.", "error");
        return;
      }

      if (!tripCodeInput.value) {
        const code = generateTripCode(startDate);
        tripCodeInput.value = code;
        document.getElementById("tripCodeDisplay").textContent = code || "‚Äî";
      }

      const routeText = routeFrom + " ‚Üí " + routeTo;
      document.getElementById("vehicleDisplay").textContent = vehicle || "‚Äî";
      document.getElementById("routeDisplay").textContent = routeText;
      document.getElementById("startDateDisplay").textContent = startDate || "‚Äî";
      summaryTitleEl.textContent =
        routeText + " ‚Ä¢ " + (startDate || "");

      step1.classList.remove("active");
      step2.classList.add("active");
      stepPill.textContent = "Step 2 of 2";
      stepIndicator.textContent = "Cost details";
    });

    // BACK (Step 2 -> Step 1)
    backStepBtn.addEventListener("click", () => {
      step2.classList.remove("active");
      step1.classList.add("active");
      stepPill.textContent = "Step 1 of 2";
      stepIndicator.textContent = "Route details";
    });

    // RESET
    resetBtn.addEventListener("click", () => {
      prefillNewTripForm();
    });

    // Show/hide advance date
    advancePaidInput.addEventListener("input", () => {
      const val = toNumber(advancePaidInput.value);
      if (val > 0) {
        advanceDateGroup.style.display = "block";
      } else {
        advanceDateGroup.style.display = "none";
        advancePaidDateInput.value = "";
      }
    });

    // New Trip button in summary
    newTripBtn.addEventListener("click", () => {
      showNewTrip();
    });

    // Edit button in summary
    editTripBtn.addEventListener("click", () => {
      formCard.classList.remove("hidden");
      summaryCard.classList.remove("summary-full");
      summaryCard.classList.add("summary-small");
      newTripBtn.classList.add("hidden");
      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
      step1.classList.remove("active");
      step2.classList.add("active");
      stepPill.textContent = "Step 2 of 2";
      stepIndicator.textContent = "Cost details";
    });

    // Save button in summary
    summarySaveBtn.addEventListener("click", () => {
      tripForm.requestSubmit();
    });

    // View saved record button
    viewSavedRecordBtn.addEventListener("click", () => {
      savedMessage.classList.add("hidden");
      summaryContent.classList.remove("hidden");
      newTripBtn.classList.remove("hidden");
    });

    // SUBMIT main Trip form
    tripForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const routeFrom = routeFromInput.value.trim();
      const routeTo = routeToInput.value.trim();
      const startDate = startDateInput.value;
      const vehicle = vehicleInput.value;
      const totalCost = toNumber(totalCostInput.value);
      const estimatedCost = toNumber(estimatedCostInput.value);
      const advancePaid = toNumber(advancePaidInput.value);
      const advancePaidDate = advancePaidDateInput.value;
      let tripCode = tripCodeInput.value;

      if (!vehicle) {
        showToast("Please select a vehicle.", "error");
        return;
      }

      if (!tripCode) {
        tripCode = generateTripCode(startDate);
        tripCodeInput.value = tripCode;
      }

      const profit = totalCost - estimatedCost;
      const pending = totalCost - advancePaid;

      const routeText = routeFrom + " ‚Üí " + routeTo;

      document.getElementById("tripCodeDisplay").textContent = tripCode || "‚Äî";
      document.getElementById("vehicleDisplay").textContent = vehicle || "‚Äî";
      document.getElementById("routeDisplay").textContent = routeText || "‚Äî";
      document.getElementById("startDateDisplay").textContent = startDate || "‚Äî";
      document.getElementById("totalCostDisplay").textContent = formatCurrency(totalCost);
      document.getElementById("estimatedCostDisplay").textContent = formatCurrency(estimatedCost);
      document.getElementById("profitDisplay").textContent = formatCurrency(profit);
      document.getElementById("advanceDisplay").textContent = formatCurrency(advancePaid);
      document.getElementById("pendingDisplay").textContent = formatCurrency(pending);
      document.getElementById("advanceDateDisplay").textContent =
        advancePaid > 0 && advancePaidDate ? advancePaidDate : "‚Äî";

      summaryStatusEl.textContent = "Saved";

      const profitDisplay = document.getElementById("profitDisplay");
      const profitBadgeText = document.getElementById("profitBadgeText");
      const pendingBadgeText = document.getElementById("pendingBadgeText");

      profitDisplay.classList.remove("positive", "negative");
      if (profit > 0) {
        profitDisplay.classList.add("positive");
        profitBadgeText.textContent = "Trip is in estimated profit (total > estimated cost)";
      } else if (profit < 0) {
        profitDisplay.classList.add("negative");
        profitBadgeText.textContent = "Trip is in estimated loss (estimated cost > total)";
      } else {
        profitBadgeText.textContent = "Estimated break-even trip";
      }

      if (pending > 0) {
        pendingBadgeText.textContent = "Client has pending payment";
      } else if (pending < 0) {
        pendingBadgeText.textContent = "Extra amount received";
      } else {
        pendingBadgeText.textContent = "Fully paid";
      }

      summaryTitleEl.textContent =
        (tripCode ? tripCode + " ‚Ä¢ " : "") +
        routeText +
        (startDate ? " ‚Ä¢ " + startDate : "");

      const existing = getStoredTrips().find(t => t.tripCode === tripCode);
      const status = existing ? (existing.status || "active") : "active";

      const payload = {
        ...(existing || {}),
        tripCode,
        routeFrom,
        routeTo,
        startDate,
        vehicle,
        totalTransportCost: totalCost,
        estimatedTripCost: estimatedCost,
        estimatedProfit: profit,
        advancePaid,
        advancePaidDate: advancePaidDate || null,
        pendingFromClient: pending,
        status,
        lastUpdated: new Date().toISOString()
      };

      if (existing && existing.transactions) payload.transactions = existing.transactions;
      if (existing && existing.payments) payload.payments = existing.payments;

      // remember last route & vehicle
      localStorage.setItem("lastRouteFrom", routeFrom);
      localStorage.setItem("lastRouteTo", routeTo);
      localStorage.setItem("lastVehicle", vehicle);

      await saveTrip(payload);

      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();

      formCard.classList.add("hidden");
      summaryCard.classList.remove("summary-small");
      summaryCard.classList.add("summary-full");
      summaryContent.classList.add("hidden");
      savedMessage.classList.remove("hidden");
      newTripBtn.classList.add("hidden");

      clearFormDirty();
    });

    // ensure date default is today when adding new txns ‚Äî handled when rendering inputs
  </script>
</body>
</html>



<!-- APPENDED PART 2 -->
<script>

	// ---------- PART 2: Supabase sync, realtime, autosave, sidebar, mobile nav, reports, prediction ----------

/*
  NOTE:
  - This code expects `supabaseClient` (created earlier) and the UI element IDs present in Part 1.
  - Paste this immediately after the marker inside the same <script> that contains Part 1.
*/

/* ---------- Supabase helpers (push / pull / merge) ---------- */

async function pushTripToSupabase(trip) {
  try {
    const normalized = normalizeTripForDB(trip);
    // upsert by tripCode (primary key) - requires a unique constraint on tripCode in your Supabase table
    const { data, error } = await supabaseClient
      .from("trips")
      .upsert(normalized, { onConflict: ["tripCode"] })
      .select()
      .single();

    if (error) {
      console.warn("Supabase upsert error:", error);
      return { ok: false, error };
    }
    return { ok: true, data };
  } catch (err) {
    console.warn("pushTripToSupabase error:", err);
    return { ok: false, error: err };
  }
}

async function pullTripsFromSupabase() {
  try {
    const { data, error } = await supabaseClient
      .from("trips")
      .select("*")
      .order("lastUpdated", { ascending: false });

    if (error) {
      console.warn("Supabase fetch error:", error);
      return [];
    }
    return Array.isArray(data) ? data : [];
  } catch (err) {
    console.warn("pullTripsFromSupabase error:", err);
    return [];
  }
}

/* Merge strategy:
   - Local wins for fields with more recent lastUpdated
   - If remote is newer, use remote
   - Keeps both transactions/payments arrays merged uniquely by id
*/
function mergeTripObjects(local, remote) {
  if (!local) return remote;
  if (!remote) return local;

  const localUpdated = new Date(local.lastUpdated || 0).getTime();
  const remoteUpdated = new Date(remote.lastUpdated || 0).getTime();

  const winner = remoteUpdated > localUpdated ? remote : local;
  const loser = remoteUpdated > localUpdated ? local : remote;

  const merged = { ...winner };

  // Merge transactions: keep unique ids
  merged.transactions = merged.transactions || {};
  loser.transactions = loser.transactions || {};
  Object.keys({ ...merged.transactions, ...loser.transactions }).forEach(cat => {
    const a = merged.transactions[cat] || [];
    const b = loser.transactions[cat] || [];
    const map = new Map();
    a.concat(b).forEach(item => map.set(item.id || uid("x"), item));
    merged.transactions[cat] = Array.from(map.values());
  });

  // Merge payments
  merged.payments = merged.payments || [];
  loser.payments = loser.payments || [];
  const payMap = new Map();
  merged.payments.concat(loser.payments).forEach(p => payMap.set(p.id || uid("p"), p));
  merged.payments = Array.from(payMap.values());

  // Keep computed fields from winner, but recalc derived totals
  updateDerivedCategoryTotals(merged);
  merged.lastUpdated = new Date().toISOString();

  return merged;
}

/* Safe, silent background sync that tries Supabase first then merges */
async function safeSyncAllLocalToSupabase() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.warn("Supabase not configured; skipping safeSyncAllLocalToSupabase.");
    return;
  }

  // Pull remote trips
  const remoteTrips = await pullTripsFromSupabase().catch(() => []);
  const localTrips = getStoredTrips();

  // Build maps
  const remoteMap = new Map(remoteTrips.map(r => [r.tripCode, r]))
  const localMap = new Map(localTrips.map(l => [l.tripCode, l]))

  // Merge keys
  const allKeys = new Set([...remoteMap.keys(), ...localMap.keys()]);

  for (const key of allKeys) {
    const local = localMap.get(key);
    const remote = remoteMap.get(key);

    const merged = mergeTripObjects(local, remote);
    // locally save merged
    const existingLocal = localTrips.findIndex(t => t.tripCode === merged.tripCode);
    if (existingLocal >= 0) localTrips[existingLocal] = merged;
    else localTrips.push(merged);

    // push merged to remote (so both sides converge)
    try {
      const res = await pushTripToSupabase(merged);
      if (!res.ok) {
        console.warn("Failed to push merged trip to supabase:", merged.tripCode);
      }
    } catch (e) {
      console.warn("push error:", e);
    }
  }

  saveTrips(localTrips);
  renderTripsTable();
  renderActiveTrips();
  renderVehicleSummary();
  showToast("Auto-merged local & cloud trips.", "success", 2500);
}

/* push a single trip with optimistic local save */
async function saveTripWithSupabase(trip) {
  // local save already handled by saveTrip; use push to supabase afterwards
  const pushed = await pushTripToSupabase(trip);
  if (pushed.ok && pushed.data) {
    // merge response into local
    const trips = getStoredTrips();
    const idx = trips.findIndex(t => t.tripCode === trip.tripCode);
    if (idx >= 0) {
      const merged = mergeTripObjects(trips[idx], pushed.data);
      trips[idx] = merged;
      saveTrips(trips);
      renderTripsTable();
      renderActiveTrips();
      renderVehicleSummary();
    }
    return true;
  }
  return false;
}

/* Patch existing saveTrip to attempt supabase push (without breaking local-first behavior)
   We'll wrap the original saveTrip so existing calls continue to work.
*/
const _orig_saveTrip = saveTrip;
saveTrip = async function(payload) {
  // first do local save & existing logic (silent)
  await _orig_saveTrip(payload);

  // if supabase configured, attempt to push in background (silently)
  if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    try {
      await saveTripWithSupabase(payload);
      // show a small positive toast only on explicit user saves (already done by original)
    } catch (e) {
      console.warn("Background supabase push failed:", e);
    }
  }
};

/* Realtime listener: update local store when a remote change occurs */
function setupRealtimeSubscription() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;

  try {
    // subscribe to changes in "trips" table
    supabaseClient
      .channel("public:trips")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "trips" },
        async (payload) => {
          try {
            const rec = payload.new || payload.old;
            if (!rec || !rec.tripCode) return;
            const local = getStoredTrips();
            const idx = local.findIndex(t => t.tripCode === rec.tripCode);
            if (payload.eventType === "DELETE") {
              if (idx >= 0) {
                local.splice(idx, 1);
                saveTrips(local);
                renderTripsTable();
                renderActiveTrips();
                renderVehicleSummary();
                showToast(`Trip ${rec.tripCode} removed from cloud.`, "info", 1800);
              }
              return;
            }
            // On INSERT/UPDATE -> merge
            const merged = mergeTripObjects(local[idx], rec);
            if (idx >= 0) local[idx] = merged; else local.push(merged);
            saveTrips(local);
            renderTripsTable();
            renderActiveTrips();
            renderVehicleSummary();
            // silent small toast (non-intrusive)
            // showToast(`Cloud update: ${rec.tripCode}`, "info", 1400);
          } catch (e) {
            console.warn("Realtime payload handling error", e);
          }
        }
      )
      .subscribe();
  } catch (e) {
    console.warn("Realtime setup failed:", e);
  }
}

/* ---------- Auto-backup scheduler ---------- */

let autoBackupIntervalId = null;

function startAutoBackup(intervalMinutes = 10) {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
  clearAutoBackup();
  autoBackupIntervalId = setInterval(() => {
    safeSyncAllLocalToSupabase();
  }, Math.max(1, intervalMinutes) * 60 * 1000);
  showToast(`Auto-backup every ${intervalMinutes} min enabled.`, "success", 1800);
}

function clearAutoBackup() {
  if (autoBackupIntervalId) {
    clearInterval(autoBackupIntervalId);
    autoBackupIntervalId = null;
  }
}

/* Attach a small hidden control for toggling auto-backup (non-intrusive) */
(function addAutoBackupToggle() {
  const el = document.createElement("div");
  el.style.position = "fixed";
  el.style.left = "12px";
  el.style.bottom = "12px";
  el.style.zIndex = "99998";
  el.style.fontSize = "12px";
  el.innerHTML = `<button id="autoBackupToggle" class="btn-ghost btn-small" title="Toggle auto-backup">Auto-backup: Off</button>`;
  document.body.appendChild(el);
  document.getElementById("autoBackupToggle").addEventListener("click", (e) => {
    if (autoBackupIntervalId) {
      clearAutoBackup();
      e.currentTarget.textContent = "Auto-backup: Off";
      showToast("Auto-backup disabled.", "info");
    } else {
      startAutoBackup(10);
      e.currentTarget.textContent = "Auto-backup: On";
    }
  });
})();

/* ---------- Sidebar / Mobile nav wiring ---------- */
(function setupSidebarToggle() {
  // build toggle button in header
  const btn = document.createElement("button");
  btn.className = "btn-ghost";
  btn.id = "sidebarToggleBtn";
  btn.textContent = "‚ò∞";
  const headerActions = document.querySelector(".header-actions");
  if (headerActions) headerActions.insertBefore(btn, headerActions.firstChild);

  btn.addEventListener("click", () => {
    const sidebar = document.querySelector(".sidebar");
    if (!sidebar) {
      // create simple sidebar when missing (Part1 had hidden sidebar for small screens)
      const s = document.createElement("div");
      s.className = "sidebar expanded";
      s.innerHTML = `<div class="logo">Sasi Transports</div>
        <button class="nav-btn" id="navHomeBtn">üè† Home</button>
        <button class="nav-btn" id="navHistoryBtn">üìú History</button>
        <button class="nav-btn" id="navNewTripBtn">‚ûï New Trip</button>
        <button class="nav-btn" id="navVehiclesBtn">üöö Vehicles</button>`;
      document.querySelector(".page").insertBefore(s, document.querySelector(".page").firstChild);
      wireSidebarButtons();
      return;
    }
    sidebar.classList.toggle("expanded");
  });

  function wireSidebarButtons() {
    const navHome = document.getElementById("navHomeBtn");
    const navHistory = document.getElementById("navHistoryBtn");
    const navNewTrip = document.getElementById("navNewTripBtn");
    if (navHome) navHome.addEventListener("click", showHome);
    if (navHistory) navHistory.addEventListener("click", showHistory);
    if (navNewTrip) navNewTrip.addEventListener("click", showNewTrip);
  }
})();

/* Mobile bottom nav wiring */
(function setupMobileBottomNav() {
  const nav = document.querySelector(".mobile-bottom-nav");
  if (!nav) {
    const el = document.createElement("div");
    el.className = "mobile-bottom-nav";
    el.innerHTML = `
      <button id="mbHome" class="btn-small">Home</button>
      <button id="mbHistory" class="btn-small">History</button>
      <button id="mbNew" class="btn-small">New</button>
    `;
    document.body.appendChild(el);
    document.getElementById("mbHome").addEventListener("click", showHome);
    document.getElementById("mbHistory").addEventListener("click", showHistory);
    document.getElementById("mbNew").addEventListener("click", showNewTrip);
  }
})();

/* ---------- Simple reports / monthly summary (UI helper) ---------- */
function generateMonthlyReport(year, month) {
  const trips = getStoredTrips();
  const monthStr = month.toString().padStart(2, "0");
  const filtered = trips.filter(t => (t.startDate || "").startsWith(`${year}-${monthStr}`));
  const totalBilled = filtered.reduce((s, t) => s + toNumber(t.totalTransportCost || 0), 0);
  const totalProfit = filtered.reduce((s, t) => s + toNumber(t.estimatedProfit || 0), 0);
  const totalPending = filtered.reduce((s, t) => s + toNumber(t.pendingFromClient || 0), 0);
  return { count: filtered.length, totalBilled, totalProfit, totalPending, trips: filtered };
}

/* ---------- Basic predictive profit calculator (example) ----------
   Very small demo: uses simple linear scaling by distance embedded in route text (if any).
   Replace with real model later.
*/
function predictProfitBaseline(totalTransportCost, estimatedTripCost, adjustments = 0) {
  return (totalTransportCost - estimatedTripCost) + adjustments;
}

/* ---------- Small admin utilities: clear local cache, export audit ---------- */
function clearLocalData() {
  if (!confirm("Clear all local trips and audit log? This cannot be undone on this device.")) return;
  localStorage.removeItem("trips");
  localStorage.removeItem("audit_log");
  location.reload();
}

function exportAuditLog() {
  const log = getAuditLog();
  const blob = new Blob([JSON.stringify(log, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `audit_log_${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("Audit exported.", "success");
}

/* ---------- Wire optional admin commands to console for power-users ---------- */
window.SasiAdmin = {
  safeSyncAllLocalToSupabase,
  startAutoBackup,
  clearAutoBackup,
  exportAuditLog,
  clearLocalData,
  pullTripsFromSupabase,
  pushTripToSupabase,
  generateMonthlyReport,
  setupRealtimeSubscription
};

/* ---------- Start realtime subscription if configured ---------- */
try {
  setupRealtimeSubscription();
} catch (e) {
  console.warn("Realtime setup threw:", e);
}

/* ---------- Kick off an initial background merge if supabase configured ---------- */
if (SUPABASE_URL && SUPABASE_ANON_KEY) {
  // schedule a quick merge after init
  setTimeout(() => {
    safeSyncAllLocalToSupabase().catch(() => {});
  }, 1500);
}

</script>
</body>
</html>
